<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Panel Admin Kurasi</title>
    <script src="https://cdn.tailwindcss.com"></script>
	<link rel="icon" type="image/x-icon" href="https://kemendikdasmen.go.id/web/image/website/21/favicon?unique=c3563e4">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .sidebar-link.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            font-weight: 600;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        #logBox, #cacheLogBox {
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            height: 300px;
            overflow-y: auto;
            border-radius: 8px;
            padding: 16px;
            background-color: #1E293B; /* slate-800 */
            color: #E2E8F0; /* slate-200 */
        }
        .form-input {
             @apply mt-1 block w-full px-3 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md;
        }
        .login-input {
            @apply w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-300;
        }
    </style>
</head>
<body class="bg-slate-900">

    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 to-gray-800 p-4">
        <div class="w-full max-w-md">
            <form id="login-form" class="bg-slate-800/50 backdrop-blur-xl shadow-2xl rounded-2xl px-8 pt-10 pb-8 mb-4 border border-slate-700">
                 <div class="mb-8 text-center">
                    <h1 class="text-3xl font-bold text-white">Admin Panel Login</h1>
                    <p class="text-slate-400 mt-2">Silakan masuk untuk melanjutkan</p>
                </div>
                <div class="mb-4">
                    <label class="block text-slate-300 text-sm font-bold mb-2" for="username">
                        Username
                    </label>
                    <div class="relative">
                         <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                             <i class="fas fa-user text-gray-400"></i>
                         </span>
                         <input class="login-input pl-10" id="username" type="text" placeholder="Masukkan username admin" required>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-slate-300 text-sm font-bold mb-2" for="password">
                        Password
                    </label>
                    <div class="relative">
                         <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                             <i class="fas fa-lock text-gray-400"></i>
                         </span>
                        <input class="login-input pl-10" id="password" type="password" placeholder="******************" required>
                    </div>
                </div>
                 <p id="login-error" class="text-red-500 text-xs italic mb-4 h-4"></p>
                <div class="flex items-center justify-between">
                    <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-all duration-300 disabled:opacity-50" type="submit">
                        Masuk
                    </button>
                </div>
                 <div class="mt-4 text-center">
                    <a href="./" class="text-indigo-400 hover:text-indigo-300 text-sm transition-colors">Kembali ke Home</a>
                </div>
            </form>
            <p class="text-center text-gray-500 text-xs">
                &copy;2024 Kurasi Konten.
            </p>
        </div>
    </div>


    <div id="admin-panel" class="hidden">
        <div class="flex min-h-screen bg-slate-100">
            <aside class="w-64 bg-slate-800 text-slate-200 flex flex-col">
                <div class="p-6 text-center border-b border-slate-700">
                    <h1 class="text-2xl font-bold text-white">Admin Kurasi</h1>
                </div>
                <nav class="flex-1 p-4 space-y-2">
                    <a href="#" class="sidebar-link flex items-center py-2 px-4 rounded-lg transition-colors hover:bg-slate-700 active" data-target="dashboard">
                        <i class="fas fa-tachometer-alt w-6"></i><span>Dashboard</span>
                    </a>
                    <a href="#" class="sidebar-link flex items-center py-2 px-4 rounded-lg transition-colors hover:bg-slate-700" data-target="users">
                        <i class="fas fa-users-cog w-6"></i><span>Manajemen Pengguna</span>
                    </a>
                    <a href="#" class="sidebar-link flex items-center py-2 px-4 rounded-lg transition-colors hover:bg-slate-700" data-target="content">
                        <i class="fas fa-file-alt w-6"></i><span>Manajemen Konten</span>
                    </a>
                    <a href="#" class="sidebar-link flex items-center py-2 px-4 rounded-lg transition-colors hover:bg-slate-700" data-target="assignments">
                        <i class="fas fa-tasks w-6"></i><span>Penugasan</span>
                    </a>
                    <a href="#" class="sidebar-link flex items-center py-2 px-4 rounded-lg transition-colors hover:bg-slate-700" data-target="hasil">
                        <i class="fas fa-check-square w-6"></i><span>Hasil Kurasi</span>
                    </a>
                    <a href="#" class="sidebar-link flex items-center py-2 px-4 rounded-lg transition-colors hover:bg-slate-700" data-target="settings">
                        <i class="fas fa-cogs w-6"></i><span>Pengaturan</span>
                    </a>
                </nav>
                 <div class="p-4 border-t border-slate-700">
                    <a href="#" id="logout-btn" class="flex items-center py-2 px-4 rounded-lg text-red-400 transition-colors hover:bg-red-500 hover:text-white">
                        <i class="fas fa-sign-out-alt w-6"></i><span>Logout</span>
                    </a>
                </div>
            </aside>

            <main class="flex-1 p-8 overflow-y-auto">
                
                <div id="dashboard-page" class="page-content">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-slate-800">Dashboard</h2>
                         <button id="refresh-data-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                            <i class="fas fa-sync-alt mr-2"></i><span>Muat Ulang Data</span>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center space-x-4">
                            <i class="fas fa-users text-4xl text-blue-500"></i>
                            <div>
                                <p class="text-slate-500">Total Pengguna</p>
                                <p id="total-users" class="text-3xl font-bold">...</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center space-x-4">
                            <i class="fas fa-file-alt text-4xl text-green-500"></i>
                            <div>
                                <p class="text-slate-500">Total Konten</p>
                                <p id="total-content" class="text-3xl font-bold">...</p>
                            </div>
                        </div>
                         <div class="bg-white p-6 rounded-lg shadow-md flex items-center space-x-4">
                            <i class="fas fa-check-double text-4xl text-indigo-500"></i>
                            <div>
                                <p class="text-slate-500">Total Kurasi</p>
                                <p id="total-curations" class="text-3xl font-bold">...</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold text-slate-800 mb-3">Pembaruan Cache Dashboard Publik</h3>
                        <p class="text-slate-600 mb-4">
                            Klik tombol di bawah untuk mengambil semua data terbaru, menghitung statistik, dan memperbarui tampilan di halaman utama (`index.html`). 
                            Proses ini akan menggunakan banyak kuota 'read' untuk Anda sebagai admin, tetapi akan membuat halaman utama sangat hemat untuk pengunjung.
                        </p>
                        <button id="update-cache-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-cloud-upload-alt mr-2"></i>
                            <span>Perbarui Cache Sekarang</span>
                        </button>
                         <div class="mt-4">
                            <h4 class="text-md font-semibold text-slate-700 mb-2">Log Proses Cache:</h4>
                            <div id="cacheLogBox">Menunggu perintah...</div>
                        </div>
                    </div>
                </div>

                <div id="users-page" class="page-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-slate-800">Manajemen Pengguna</h2>
                        <button id="add-user-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i>Tambah Pengguna</button>
                    </div>
                    <div class="mb-4">
                        <input type="search" id="search-user-input" placeholder="Cari nama pengguna..." class="form-input w-full max-w-sm">
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b">
                                    <th class="py-2 px-4">Nama</th>
                                    <th class="py-2 px-4">Instansi</th>
                                    <th class="py-2 px-4">ID/Username</th>
                                    <th class="py-2 px-4">Role</th>
                                    <th class="py-2 px-4">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <tr><td colspan="5" class="text-center p-4">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="content-page" class="page-content hidden">
                     <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-slate-800">Manajemen Konten</h2>
                        <div class="flex space-x-2">
                             <button id="download-template-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center"><i class="fas fa-download mr-2"></i>Unduh Template</button>
                             <button id="upload-excel-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg flex items-center"><i class="fas fa-file-excel mr-2"></i>Upload Excel</button>
                             <button id="add-content-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center"><i class="fas fa-plus mr-2"></i>Tambah Konten</button>
                             <button id="delete-all-content-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg flex items-center"><i class="fas fa-trash mr-2"></i>Hapus Semua Konten</button>
                             <input type="file" id="excel-file-input" class="hidden" accept=".xlsx, .xls">
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b">
                                    <th class="py-2">Judul</th>
                                    <th class="py-2">URL</th>
                                    <th class="py-2">Subjek</th>
                                    <th class="py-2">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="content-table-body">
                                <tr><td colspan="4" class="text-center p-4">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="assignments-page" class="page-content hidden">
                     <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-slate-800">Penugasan Konten</h2>
                        <button id="random-assign-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                            <i class="fas fa-random mr-2"></i>Bagikan Penugasan Acak
                        </button>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="mb-4">
                            <label for="user-select" class="block text-sm font-medium text-slate-700">Pilih Pengguna (Role Kurator):</label>
                            <select id="user-select" class="form-input mt-1">
                                <option value="">-- Pilih Kurator --</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                            <div>
                                <h3 class="font-bold text-lg mb-2">Konten yang Ditugaskan</h3>
                                <ul id="assigned-content-list" class="border rounded-md p-2 h-96 overflow-y-auto"></ul>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg mb-2">Daftar Semua Konten</h3>
                                <ul id="all-content-list" class="border rounded-md p-2 h-96 overflow-y-auto"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="hasil-page" class="page-content hidden">
                    <h2 class="text-3xl font-bold text-slate-800 mb-6">Hasil dan Kemajuan Kurasi</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md overflow-auto max-h-[75vh]">
                        <table class="w-full text-left whitespace-nowrap">
                            <thead id="hasil-table-head">
                                </thead>
                            <tbody id="hasil-table-body">
                                <tr><td colspan="3" class="text-center p-4">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>


                <div id="settings-page" class="page-content hidden">
                     <h2 class="text-3xl font-bold text-slate-800 mb-6">Pengaturan & Data</h2>
                     <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl mx-auto">
                        <div class="border-b pb-6 mb-6">
                            <h3 class="text-xl font-semibold text-slate-800 mb-4">Backup & Restore Data</h3>
                            <p class="text-sm text-slate-500 mb-4">Simpan seluruh data (pengguna, konten, penugasan, kurasi) ke dalam satu file JSON, atau pulihkan data dari file backup.</p>
                            <div class="flex space-x-4">
                                <button id="backupButton" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center"><i class="fas fa-download mr-2"></i>Backup Seluruh Data</button>
                                <button id="restoreButtonTrigger" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center"><i class="fas fa-upload mr-2"></i>Restore Dari File</button>
                                <input type="file" id="restoreFileInput" class="hidden" accept="application/json">
                            </div>
                        </div>

                        <div class="bg-red-50 border-l-4 border-red-400 text-red-700 p-4 rounded-md mb-6" role="alert">
                            <p class="font-bold">Zona Berbahaya!</p>
                            <p>Tindakan reset akan menghapus koleksi `users`, `contents`, `assignments`, dan `curations` lalu mengisinya dengan data default.</p>
                        </div>
                        <button id="resetButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg"><i class="fas fa-sync-alt mr-2"></i>Reset & Buat Database Default</button>
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold text-slate-700 mb-2">Log Proses:</h3>
                            <div id="logBox">Menunggu perintah...</div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>


    <div id="user-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-20">
      <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3">
          <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="user-modal-title">Tambah Pengguna Baru</h3>
          <div class="mt-2 px-7 py-3">
            <form id="user-form" class="space-y-4">
              <input type="hidden" id="user-id">
              <div><label class="block text-sm font-medium">Nama</label><input type="text" id="user-nama" class="form-input" required></div>
              <div><label class="block text-sm font-medium">Instansi</label><input type="text" id="user-instansi" class="form-input" required></div>
              <div><label class="block text-sm font-medium">ID/Username</label><input type="text" id="user-username" class="form-input" required></div>
              <div><label class="block text-sm font-medium">Password</label><input type="password" id="user-password" class="form-input" required></div>
              <div><label class="block text-sm font-medium">Role</label>
                <select id="user-role" class="form-input" required>
                    <option value="Kurator">Kurator</option>
                    <option value="Supervisor">Supervisor</option>
                    <option value="Admin">Admin</option>
                </select>
              </div>
              <div class="items-center px-4 py-3 space-y-2">
                <button type="submit" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600">Simpan</button>
                <button type="button" id="cancel-user-modal" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">Batal</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    
    <div id="content-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-20">
      <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3">
          <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="content-modal-title">Tambah Konten Baru</h3>
          <div class="mt-2 px-7 py-3">
            <form id="content-form" class="space-y-4">
              <input type="hidden" id="content-id">
              <div><label class="block text-sm font-medium">Judul Konten</label><input type="text" id="content-title" class="form-input" required></div>
              <div><label class="block text-sm font-medium">URL Konten</label><input type="url" id="content-url" placeholder="https://..." class="form-input" required></div>
              <div><label class="block text-sm font-medium">Subjek</label><input type="text" id="content-subject" class="form-input" required></div>
              <div class="items-center px-4 py-3 space-y-2">
                <button type="submit" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600">Simpan</button>
                <button type="button" id="cancel-content-modal" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">Batal</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
      <div class="relative top-20 mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
          </div>
          <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2" id="confirm-modal-title">Konfirmasi</h3>
          <div class="mt-2 px-7 py-3">
            <p class="text-sm text-gray-500" id="confirm-modal-body">
              Apakah Anda yakin?
            </p>
          </div>
          <div class="items-center px-4 py-3 sm:flex">
            <button id="confirm-modal-yes" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full sm:w-auto shadow-sm hover:bg-red-600">
              Ya, Lanjutkan
            </button>
            <button id="confirm-modal-no" class="mt-3 sm:mt-0 sm:ml-3 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full sm:w-auto shadow-sm hover:bg-gray-300">
              Batal
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <div id="info-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
      <div class="relative top-20 mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
            <i class="fas fa-info-circle text-blue-600 text-xl"></i>
          </div>
          <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2" id="info-modal-title">Informasi</h3>
          <div class="mt-2 px-7 py-3">
            <p class="text-sm text-gray-500" id="info-modal-body">
              Pesan info.
            </p>
          </div>
          <div class="items-center px-4 py-3">
            <button id="info-modal-ok" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600">
              OK
            </button>
          </div>
        </div>
      </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, addDoc, deleteDoc, writeBatch, updateDoc, arrayUnion, arrayRemove, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

		const firebaseConfig = {
		  apiKey: "AIzaSyB0biVlYEZg7p5UntYRDnyjdQCfe15_vmk",
		  authDomain: "kurasidirsd.firebaseapp.com",
		  projectId: "kurasidirsd",
		  storageBucket: "kurasidirsd.firebasestorage.app",
		  messagingSenderId: "168494524685",
		  appId: "1:168494524685:web:b209da5c5fec9e7d5be844"
		};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- State Management ---
        let allUsers = [];
        let allContent = [];
        let allAssignments = {};
        let allCurations = [];

        // --- UI Elements ---
        const loginScreen = document.getElementById('login-screen');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const pageContents = document.querySelectorAll('.page-content');
        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        const userModal = document.getElementById('user-modal');
        const contentModal = document.getElementById('content-modal');
        const userForm = document.getElementById('user-form');
        const contentForm = document.getElementById('content-form');
        const logBox = document.getElementById('logBox');
        const cacheLogBox = document.getElementById('cacheLogBox');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalYes = document.getElementById('confirm-modal-yes');
        const confirmModalNo = document.getElementById('confirm-modal-no');
        const infoModal = document.getElementById('info-modal');
        let confirmCallback = null;

        // --- Login & Authentication Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
                showAdminPanel();
                fetchData(); // Automatically fetch data on load if logged in
            } else {
                showLoginScreen();
            }
        });

        function showAdminPanel() {
            loginScreen.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            document.body.classList.remove('bg-slate-900');
            document.body.classList.add('bg-slate-100');
        }
        
        function showLoginScreen() {
            sessionStorage.removeItem('isAdminLoggedIn');
            adminPanel.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            document.body.classList.add('bg-slate-900');
            document.body.classList.remove('bg-slate-100');
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = '';
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginButton = loginForm.querySelector('button[type="submit"]');
            
            loginButton.disabled = true;
            loginButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Mencoba Masuk...`;

            const usersRef = collection(db, "users");
            const q = query(usersRef, where("username", "==", username), where("password", "==", password), where("role", "==", "Admin"));

            try {
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    sessionStorage.setItem('isAdminLoggedIn', 'true');
                    showAdminPanel();
                    await fetchData();
                } else {
                    loginError.textContent = 'Username, password, atau role tidak valid.';
                }
            } catch (error) {
                console.error("Error logging in: ", error);
                loginError.textContent = 'Terjadi kesalahan saat login.';
            } finally {
                loginButton.disabled = false;
                loginButton.innerHTML = `Masuk`;
            }
        });

        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            showLoginScreen();
        });

        // --- Modal Logic ---
        function showConfirm(title, body, callback) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-body').textContent = body;
            confirmCallback = callback;
            confirmModal.classList.remove('hidden');
        }

        confirmModalYes.addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            confirmModal.classList.add('hidden');
        });

        confirmModalNo.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
        });
        
        function showInfo(title, body) {
            document.getElementById('info-modal-title').textContent = title;
            document.getElementById('info-modal-body').textContent = body;
            infoModal.classList.remove('hidden');
        }

        document.getElementById('info-modal-ok').addEventListener('click', () => {
            infoModal.classList.add('hidden');
        });

        // --- Navigation Logic ---
        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const target = link.dataset.target;
                sidebarLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                pageContents.forEach(page => {
                    page.id === `${target}-page` ? page.classList.remove('hidden') : page.classList.add('hidden');
                });
            });
        });
        
        // --- Data Fetching & Rendering ---
        async function fetchData() {
            const refreshBtn = document.getElementById('refresh-data-btn');
            refreshBtn.disabled = true;
            refreshBtn.querySelector('span').textContent = 'Memuat...';
            try {
                const [usersSnap, contentSnap, assignmentsSnap, curationsSnap] = await Promise.all([
                    getDocs(collection(db, "users")),
                    getDocs(collection(db, "contents")),
                    getDocs(collection(db, "assignments")),
                    getDocs(collection(db, "curations"))
                ]);
                
                allUsers = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allContent = contentSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allCurations = curationsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                allAssignments = {};
                assignmentsSnap.docs.forEach(doc => {
                    allAssignments[doc.id] = doc.data().contentIds || [];
                });
                
                updateDashboardStats();
                renderUsersTable();
                renderContentTable();
                renderUserSelect();
                renderHasilTable();
                // When a user is selected in dropdown, refresh their assignment list
                const selectedUser = document.getElementById('user-select').value;
                if(selectedUser) renderAssignmentLists(selectedUser);

            } catch (error) {
                console.error("Gagal mengambil data:", error);
                showInfo('Error', `Gagal memuat data dari database: ${error.message}`);
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.querySelector('span').textContent = 'Muat Ulang Data';
            }
        }
        
        document.getElementById('refresh-data-btn').addEventListener('click', async () => {
            await fetchData();
            showInfo('Sukses', 'Semua data telah berhasil dimuat ulang.');
        });

        function updateDashboardStats() {
            document.getElementById('total-users').textContent = allUsers.length;
            document.getElementById('total-content').textContent = allContent.length;
            document.getElementById('total-curations').textContent = allCurations.length;
        }

        function renderUsersTable() {
            const tbody = document.getElementById('users-table-body');
            const searchTerm = document.getElementById('search-user-input').value.toLowerCase();
            const filteredUsers = allUsers.filter(user => user.nama.toLowerCase().includes(searchTerm));

            if (filteredUsers.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-slate-500">Pengguna tidak ditemukan.</td></tr>`;
                return;
            }

            tbody.innerHTML = filteredUsers.map(u => `
                <tr class="border-b hover:bg-slate-50">
                    <td class="py-2 px-4">${u.nama}</td>
                    <td class="py-2 px-4">${u.instansi}</td>
                    <td class="py-2 px-4">${u.username}</td>
                    <td class="py-2 px-4">${u.role}</td>
                    <td class="py-2 px-4 whitespace-nowrap">
                        <button class="edit-user-btn text-blue-500 hover:text-blue-700" data-id="${u.id}"><i class="fas fa-edit"></i></button>
                        <button class="delete-user-btn text-red-500 hover:text-red-700 ml-2" data-id="${u.id}"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }
        
        function renderContentTable() {
            const tbody = document.getElementById('content-table-body');
            tbody.innerHTML = allContent.map(c => `
                <tr class="border-b hover:bg-slate-50">
                    <td class="py-2">${c.title}</td>
                    <td class="py-2 truncate max-w-xs">${c.url}</td>
                    <td class="py-2">${c.subject}</td>
                    <td class="py-2">
                        <button class="edit-content-btn text-blue-500 hover:text-blue-700" data-id="${c.id}"><i class="fas fa-edit"></i></button>
                        <button class="delete-content-btn text-red-500 hover:text-red-700 ml-2" data-id="${c.id}"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }
        
        function renderUserSelect() {
            const select = document.getElementById('user-select');
            select.innerHTML = '<option value="">-- Pilih Kurator --</option>';
            allUsers.filter(u => u.role === 'Kurator').forEach(u => {
                const option = document.createElement('option');
                option.value = u.username;
                option.textContent = `${u.nama} (${u.username})`;
                select.appendChild(option);
            });
        }

        // === FUNGSI YANG DIPERBARUI ===
        function renderAssignmentLists(username) {
            // Bagian 1: Render daftar kiri (konten yang ditugaskan ke pengguna saat ini).
            const assignedIdsForCurrentUser = new Set(allAssignments[username] || []);
            const assignedContentForCurrentUser = allContent.filter(c => assignedIdsForCurrentUser.has(c.id));

            document.getElementById('assigned-content-list').innerHTML = assignedContentForCurrentUser.map(c => `
                <li class="flex justify-between items-center p-2 hover:bg-gray-100 rounded">
                    <span>${c.title}</span>
                    <button class="unassign-btn text-red-500 text-xs font-semibold" data-content-id="${c.id}">LEPAS</button>
                </li>`).join('');

            // Bagian 2: Buat peta terbalik dari contentId -> [daftar username] untuk menampilkan status.
            const contentToUsersMap = new Map();
            allContent.forEach(c => contentToUsersMap.set(c.id, [])); // Inisialisasi peta
            for (const uname in allAssignments) {
                const contentIds = allAssignments[uname] || [];
                contentIds.forEach(cid => {
                    if (contentToUsersMap.has(cid)) {
                        contentToUsersMap.get(cid).push(uname);
                    }
                });
            }

            // Bagian 3: Render daftar kanan (semua konten dengan status dan tombol aksi).
            document.getElementById('all-content-list').innerHTML = allContent.map(c => {
                const assignedToUsers = contentToUsersMap.get(c.id) || [];
                const isAssignedToCurrentUser = assignedIdsForCurrentUser.has(c.id);

                let statusText = '';
                if (assignedToUsers.length > 0) {
                    statusText = `<span class="text-xs text-slate-500 mt-1 block truncate">Ditugaskan ke: ${assignedToUsers.join(', ')}</span>`;
                } else {
                    statusText = `<span class="text-xs text-green-600 mt-1 block">Tersedia</span>`;
                }
                
                // Jika tidak ditugaskan ke pengguna saat ini, tombol "TUGASKAN" akan muncul.
                const actionButton = !isAssignedToCurrentUser
                    ? `<button class="assign-btn text-blue-500 text-xs font-semibold" data-content-id="${c.id}">TUGASKAN</button>`
                    : `<span class="text-xs text-gray-400 font-semibold">DITUGASKAN</span>`;

                return `
                <li class="flex justify-between items-center p-2 border-b last:border-b-0 hover:bg-slate-50">
                    <div class="flex-1 min-w-0 pr-2">
                        <span class="font-medium text-slate-700">${c.title}</span>
                        ${statusText}
                    </div>
                    ${actionButton}
                </li>`;
            }).join('');
        }

        function renderHasilTable() {
            const thead = document.getElementById('hasil-table-head');
            const tbody = document.getElementById('hasil-table-body');
            if (!thead || !tbody) return;

            const contentStats = {};
            allContent.forEach(content => {
                contentStats[content.id] = {
                    title: content.title,
                    assignedTo: new Set(),
                    completedBy: new Set()
                };
            });

            const curatorUsernameToId = new Map();
            allUsers.forEach(user => {
                if (user.role === 'Kurator') {
                    curatorUsernameToId.set(user.username, user.id);
                }
            });

            for (const username in allAssignments) {
                const curatorId = curatorUsernameToId.get(username);
                if (curatorId) {
                    const contentIds = allAssignments[username] || [];
                    contentIds.forEach(contentId => {
                        if (contentStats[contentId]) {
                            contentStats[contentId].assignedTo.add(curatorId);
                        }
                    });
                }
            }

            allCurations.forEach(curation => {
                if (contentStats[curation.contentId]) {
                    contentStats[curation.contentId].completedBy.add(curation.userId);
                }
            });

            thead.innerHTML = `
                <tr class="border-b bg-slate-100 sticky top-0 z-10">
                    <th class="py-3 px-4 font-semibold text-slate-600 text-left">Judul Konten</th>
                    <th class="py-3 px-4 font-semibold text-slate-600 text-center">Jumlah Pengurasi</th>
                    <th class="py-3 px-4 font-semibold text-slate-600 text-center">Progres Selesai</th>
                </tr>`;

            const contentArray = Object.values(contentStats);
            if (contentArray.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-slate-500">Tidak ada konten untuk ditampilkan.</td></tr>`;
                return;
            }

            tbody.innerHTML = contentArray.map(stats => {
                const assignedCount = stats.assignedTo.size;
                const completedCount = stats.completedBy.size;
                return `
                    <tr class="border-b hover:bg-slate-50">
                        <td class="py-2 px-4 font-medium text-slate-800">${stats.title}</td>
                        <td class="py-2 px-4 text-center font-medium">${assignedCount}</td>
                        <td class="py-2 px-4 text-center">${completedCount} dari ${assignedCount}</td>
                    </tr>
                `;
            }).join('');
        }

        // --- Event Listeners for CRUD & Actions ---
        
        document.getElementById('search-user-input').addEventListener('input', renderUsersTable);

        document.getElementById('add-user-btn').addEventListener('click', () => {
            userForm.reset();
            document.getElementById('user-id').value = '';
            document.getElementById('user-modal-title').textContent = 'Tambah Pengguna Baru';
            document.getElementById('user-password').required = true;
            userModal.classList.remove('hidden');
        });
        document.getElementById('cancel-user-modal').addEventListener('click', () => userModal.classList.add('hidden'));

        userForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('user-id').value;
            const userData = {
                nama: document.getElementById('user-nama').value,
                instansi: document.getElementById('user-instansi').value,
                username: document.getElementById('user-username').value,
                role: document.getElementById('user-role').value,
            };
            const password = document.getElementById('user-password').value;
            if (password) userData.password = password;

            if (id) {
                await setDoc(doc(db, 'users', id), userData, { merge: true });
            } else {
                await addDoc(collection(db, 'users'), userData);
            }
            await fetchData();
            userModal.classList.add('hidden');
        });

        document.getElementById('add-content-btn').addEventListener('click', () => {
            contentForm.reset(); document.getElementById('content-id').value = '';
            document.getElementById('content-modal-title').textContent = 'Tambah Konten Baru';
            contentModal.classList.remove('hidden');
        });
        document.getElementById('cancel-content-modal').addEventListener('click', () => contentModal.classList.add('hidden'));
        contentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('content-id').value;
            const contentData = { title: document.getElementById('content-title').value, url: document.getElementById('content-url').value, subject: document.getElementById('content-subject').value };
            if (id) { await setDoc(doc(db, 'contents', id), contentData, { merge: true }); } 
            else { await addDoc(collection(db, 'contents'), {...contentData, status: 'pending'}); }
            await fetchData();
            contentModal.classList.add('hidden');
        });
        
        document.body.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            if (target.matches('.edit-user-btn')) {
                const id = target.dataset.id;
                const user = allUsers.find(u => u.id === id);
                document.getElementById('user-id').value = id;
                document.getElementById('user-nama').value = user.nama;
                document.getElementById('user-instansi').value = user.instansi;
                document.getElementById('user-username').value = user.username;
                document.getElementById('user-password').value = '';
                document.getElementById('user-password').required = false;
                document.getElementById('user-role').value = user.role;
                document.getElementById('user-modal-title').textContent = 'Edit Pengguna';
                userModal.classList.remove('hidden');
            }
            if (target.matches('.delete-user-btn')) {
                 showConfirm('Hapus Pengguna', 'Yakin ingin menghapus pengguna ini?', async () => {
                    await deleteDoc(doc(db, 'users', target.dataset.id));
                    await fetchData();
                });
            }
            if (target.matches('.edit-content-btn')) {
                const id = target.dataset.id;
                const content = allContent.find(c => c.id === id);
                document.getElementById('content-id').value = id;
                document.getElementById('content-title').value = content.title;
                document.getElementById('content-url').value = content.url;
                document.getElementById('content-subject').value = content.subject;
                document.getElementById('content-modal-title').textContent = 'Edit Konten';
                contentModal.classList.remove('hidden');
            }
            if (target.matches('.delete-content-btn')) {
                showConfirm('Hapus Konten', 'Yakin ingin menghapus konten ini?', async () => {
                    await deleteDoc(doc(db, 'contents', target.dataset.id));
                    await fetchData();
                });
            }
            const username = document.getElementById('user-select').value;
            if (username) {
                const assignmentRef = doc(db, 'assignments', username);
                if (target.matches('.assign-btn')) {
                    await setDoc(assignmentRef, { contentIds: arrayUnion(target.dataset.contentId) }, { merge: true });
                    await fetchData();
                }
                if (target.matches('.unassign-btn')) {
                    await updateDoc(assignmentRef, { contentIds: arrayRemove(target.dataset.contentId) });
                    await fetchData();
                }
            }
        });

        document.getElementById('user-select').addEventListener('change', (e) => {
            const username = e.target.value;
            if (username) { renderAssignmentLists(username); } 
            else {
                document.getElementById('assigned-content-list').innerHTML = '';
                document.getElementById('all-content-list').innerHTML = ''; // PERUBAHAN DI SINI
            }
        });

        document.getElementById('delete-all-content-btn').addEventListener('click', () => {
            showConfirm(
                'Hapus Semua Konten',
                'PERINGATAN! Anda yakin akan menghapus SEMUA data konten secara permanen? Tindakan ini tidak dapat dibatalkan.',
                async () => {
                    await clearCollection('contents');
                    await fetchData();
                }
            );
        });

        document.getElementById('random-assign-btn').addEventListener('click', () => {
            showConfirm(
                'Bagikan Penugasan Acak?',
                'PERINGATAN! Ini akan MENGHAPUS semua penugasan yang ada dan membuat yang baru. Setiap kurator akan mendapatkan 12 konten secara acak. Lanjutkan?',
                async () => {
                    const curators = allUsers.filter(u => u.role === 'Kurator');
                    const contentIds = allContent.map(c => c.id);

                    if (curators.length === 0) { showInfo('Gagal', 'Tidak ada pengguna dengan role "Kurator" ditemukan.'); return; }
                    if (contentIds.length === 0) { showInfo('Gagal', 'Tidak ada konten yang tersedia untuk ditugaskan.'); return; }

                    const assignmentPool = [];
                    contentIds.forEach(id => { assignmentPool.push(id, id, id); });
                    for (let i = assignmentPool.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [assignmentPool[i], assignmentPool[j]] = [assignmentPool[j], assignmentPool[i]]; }
                    
                    const batch = writeBatch(db);
                    const assignmentsSnapshot = await getDocs(collection(db, 'assignments'));
                    assignmentsSnapshot.docs.forEach(d => batch.delete(d.ref));
                    
                    curators.forEach(curator => {
                        const assignedContentForCurator = assignmentPool.splice(0, 12);
                        if (assignedContentForCurator.length > 0) {
                            const assignmentRef = doc(db, 'assignments', curator.username);
                            batch.set(assignmentRef, { contentIds: [...new Set(assignedContentForCurator)] });
                        }
                    });

                    try {
                        await batch.commit();
                        await fetchData();
                        showInfo('Berhasil', 'Penugasan acak telah berhasil dibuat dan disimpan.');
                    } catch (error) {
                        console.error("Gagal membuat penugasan acak:", error);
                        showInfo('Error', `Terjadi kesalahan: ${error.message}`);
                    }
                }
            );
        });

        // --- Cache Update Logic ---
        function cacheLog(message) {
            cacheLogBox.innerHTML += `\n> ${message}`;
            cacheLogBox.scrollTop = cacheLogBox.scrollHeight;
        }

        async function handleUpdateCache() {
            const updateBtn = document.getElementById('update-cache-btn');
            updateBtn.disabled = true;
            updateBtn.querySelector('span').textContent = 'Sedang Memproses...';
            cacheLogBox.innerHTML = 'Memulai proses pembaruan cache...';
            try {
                cacheLog(`Menggunakan data yang telah dimuat: ${allUsers.length} pengguna, ${allContent.length} konten, ${allCurations.length} kurasi.`);
                cacheLog('Menghitung statistik...');
                const totalContentCount = allContent.length;
                const curatedContentCount = new Set(allCurations.map(c => c.contentId)).size;
                const curators = allUsers.filter(u => u.role === 'Kurator');
                const curatorCount = curators.length;
                
                cacheLog('Menyiapkan data tabel progres per individu...');
                const curatedSet = new Set(allCurations.map(c => `${c.userId}_${c.contentId}`));
                const progressTableData = curators
                    .sort((a, b) => a.nama.localeCompare(b.nama))
                    .map(curator => {
                        const assignedContentIds = allAssignments[curator.username] || [];
                        const tasks = [];
                        for (let i = 0; i < 12; i++) {
                            const contentId = assignedContentIds[i];
                            if (contentId) {
                                tasks.push(curatedSet.has(`${curator.id}_${contentId}`) ? 'completed' : 'pending');
                            } else {
                                tasks.push('empty');
                            }
                        }
                        return { curatorName: curator.nama, tasks: tasks };
                    });

                cacheLog('Menyusun data final untuk disimpan...');
                const cacheData = {
                    totalContent: totalContentCount,
                    curatedContent: curatedContentCount,
                    totalKurator: curatorCount,
                    lastUpdated: serverTimestamp(),
                    progressTableData: progressTableData
                };

                const cacheDocRef = doc(db, "dashboard_cache", "summary_stats");
                cacheLog('Menyimpan data ke `dashboard_cache/summary_stats`...');
                await setDoc(cacheDocRef, cacheData);

                cacheLog('\n BERHASIL! Cache untuk dashboard publik telah berhasil diperbarui.');
            } catch (error) {
                cacheLog(`\n TERJADI KESALAHAN: ${error.message}`);
                console.error("Gagal memperbarui cache:", error);
            } finally {
                updateBtn.disabled = false;
                updateBtn.querySelector('span').textContent = 'Perbarui Cache Sekarang';
            }
        }
        document.getElementById('update-cache-btn').addEventListener('click', handleUpdateCache);

        // --- Settings Page Logic ---
        function log(message) { logBox.innerHTML += `\n> ${message}`; logBox.scrollTop = logBox.scrollHeight; }
        
        async function clearCollection(name) {
            log(`Membersihkan koleksi '${name}'...`);
            const snapshot = await getDocs(collection(db, name));
            if (snapshot.empty) { log(`Koleksi '${name}' sudah kosong.`); return; }
            const batch = writeBatch(db);
            snapshot.docs.forEach(d => batch.delete(d.ref));
            await batch.commit();
            log(` Koleksi '${name}' berhasil dibersihkan.`);
        }

        document.getElementById('download-template-btn').addEventListener('click', () => {
            const sampleData = [{ title: "Contoh Judul Konten", url: "https://www.youtube.com/watch?v=example", subject: "Matematika" }];
            const ws = XLSX.utils.json_to_sheet(sampleData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template Konten");
            XLSX.writeFile(wb, "template_konten.xlsx");
        });

        document.getElementById('upload-excel-btn').addEventListener('click', () => document.getElementById('excel-file-input').click());
        
        document.getElementById('excel-file-input').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                log(`Membaca file ${file.name}...`);
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);

                    if (json.length === 0) {
                        log(' Gagal: File Excel kosong atau format tidak didukung.');
                        return;
                    }

                    const firstRow = json[0];
                    if (!('title' in firstRow && 'url' in firstRow && 'subject' in firstRow)) {
                        log(' Gagal: Format template tidak sesuai. Pastikan ada kolom "title", "url", dan "subject".');
                        return;
                    }
                    
                    log(`Ditemukan ${json.length} baris data. Memulai proses unggah...`);
                    const batch = writeBatch(db);
                    json.forEach(item => {
                        if (item.title && item.url) {
                            const contentRef = doc(collection(db, "contents"));
                            batch.set(contentRef, {
                                title: String(item.title),
                                url: String(item.url),
                                subject: String(item.subject || 'Umum'),
                                status: 'pending'
                            });
                        }
                    });

                    await batch.commit();
                    log(` Berhasil: ${json.length} konten baru berhasil diunggah.`);
                    await fetchData(); // Refresh data after upload
                    event.target.value = '';

                } catch (error) {
                    log(` Terjadi kesalahan: ${error.message}`);
                    console.error("Error processing Excel file:", error);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('resetButton').addEventListener('click', () => {
            showConfirm(
                'Reset Database',
                'PERINGATAN! Anda akan menghapus SEMUA data dan membuat ulang database default. Lanjutkan?',
                async () => {
                    const btn = document.getElementById('resetButton');
                    btn.disabled = true;
                    btn.innerText = 'Sedang Memproses...';
                    logBox.innerHTML = 'Memulai proses reset...';

                    try {
                        await clearCollection('users');
                        await clearCollection('contents');
                        await clearCollection('assignments');
                        await clearCollection('curations');

                        log(`Membuat pengguna default...`);
                        const defaultUsers = [
                            { nama: "Nurul Afifah", instansi: "Sekolah Cikal Serpong", password: "123456", username: "DirSD001", role: "Kurator" },
                            { nama: "Bintang Adhi Permana", instansi: "SDN Lubang Buaya 01", password: "Bangbin0103", username: "DirSD016", role: "Kurator" },
                            { nama: "Supervisor1", instansi: "Instansi Supervisor", password: "123456", username: "DirSD041", role: "Supervisor" },
                            { nama: "Admin", instansi: "Instansi Admin", password: "Admin1234", username: "Admin", role: "Admin" },
                        ];
                        const usersBatch = writeBatch(db);
                        defaultUsers.forEach(user => {
                            const userRef = doc(collection(db, "users"));
                            usersBatch.set(userRef, user);
                        });
                        await usersBatch.commit();
                        log(` Pengguna default berhasil dibuat.`);

                        await fetchData(); // Refresh data after reset
                        log('\n SEMUA PROSES SELESAI!');

                    } catch (error) {
                        log(`\n TERJADI ERROR: ${error.message}`);
                        console.error(error);
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Reset & Buat Database Default';
                    }
                }
            );
        });

        document.getElementById('backupButton').addEventListener('click', async () => {
            log('Memulai proses backup...');
            const backupData = {};
            const collectionsToBackup = ['users', 'contents', 'assignments', 'curations'];
            
            try {
                for (const collectionName of collectionsToBackup) {
                    log(`Mengekspor koleksi '${collectionName}'...`);
                    const data = collectionName === 'users' ? allUsers :
                                 collectionName === 'contents' ? allContent :
                                 collectionName === 'curations' ? allCurations : [];
                    
                    if (collectionName === 'assignments') {
                        backupData[collectionName] = Object.entries(allAssignments).map(([id, contentIds]) => ({ id, contentIds }));
                    } else {
                        backupData[collectionName] = data;
                    }
                    log(` Koleksi '${collectionName}' berhasil diekspor.`);
                }

                const jsonString = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                const date = new Date().toISOString().slice(0, 10);
                a.download = `backup-kurasi-${date}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                log('\n BACKUP BERHASIL! File telah diunduh.');

            } catch (error) {
                log(`\n TERJADI ERROR saat backup: ${error.message}`);
                console.error("Backup failed:", error);
            }
        });
        
        document.getElementById('restoreButtonTrigger').addEventListener('click', () => document.getElementById('restoreFileInput').click());
        
        document.getElementById('restoreFileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && file.type === "application/json") {
                handleRestore(file);
            } else if (file) {
                log(' Gagal: Harap pilih file backup JSON yang valid.');
            }
            event.target.value = '';
        });

        async function handleRestore(file) {
            showConfirm(
                'Restore Data?',
                'PERINGATAN! Ini akan MENGHAPUS SEMUA data yang ada saat ini dan menggantinya dengan data dari file backup. Lanjutkan?',
                async () => {
                    log('\nMemulai proses restore...');
                    const reader = new FileReader();
                    
                    reader.onload = async (e) => {
                        try {
                            const backupData = JSON.parse(e.target.result);
                            const requiredCollections = ['users', 'contents', 'assignments', 'curations'];
                            
                            const missingCollections = requiredCollections.filter(c => !backupData.hasOwnProperty(c) || !Array.isArray(backupData[c]));
                            if (missingCollections.length > 0) {
                                log(` Gagal: File backup tidak valid. Koleksi yang hilang: ${missingCollections.join(', ')}`);
                                return;
                            }

                            log('File backup valid. Menghapus data lama...');
                            for (const collectionName of requiredCollections) {
                                await clearCollection(collectionName);
                            }

                            log('Memulai penulisan data baru...');
                            for (const collectionName of requiredCollections) {
                                log(`Me-restore koleksi '${collectionName}'...`);
                                const data = backupData[collectionName];
                                if (data.length === 0) {
                                    log(`Koleksi '${collectionName}' kosong, dilewati.`);
                                    continue;
                                }
                                
                                const batch = writeBatch(db);
                                data.forEach(item => {
                                    const docId = item.id;
                                    const docData = { ...item };
                                    delete docData.id;
                                    const docRef = doc(db, collectionName, docId);
                                    batch.set(docRef, docData);
                                });
                                
                                await batch.commit();
                                log(` Koleksi '${collectionName}' berhasil di-restore.`);
                            }
                            await fetchData();
                            log('\n RESTORE BERHASIL!');

                        } catch (error) {
                            log(`\n TERJADI ERROR saat restore: ${error.message}`);
                            console.error("Restore failed:", error);
                        }
                    };
                    
                    reader.readAsText(file);
                }
            );
        }

    </script>
</body>
</html>
