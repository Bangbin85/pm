<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direktorat SD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" type="image/x-icon" href="https://kemendikdasmen.go.id/web/image/website/21/favicon?unique=c3563e4">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            background-image: linear-gradient(175deg, #f8fafc 0%, #eef2f7 100%);
        }
        .table-container {
            max-height: 65vh;
            overflow-y: auto;
        }
        thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        /* Custom animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.6s ease-out forwards;
            opacity: 0; /* Start hidden */
        }
        .fade-in-delay-1 { animation-delay: 0.1s; }
        .fade-in-delay-2 { animation-delay: 0.2s; }
        .fade-in-delay-3 { animation-delay: 0.3s; }
        .fade-in-delay-4 { animation-delay: 0.4s; }
        .fade-in-delay-5 { animation-delay: 0.5s; }

        .stat-card {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Gaya Modal */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8 min-h-screen">

    <div class="w-[95%] mx-auto">
        <!-- Header -->
        <header class="mb-8 fade-in">
            <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 tracking-tight">
                Dashboard Kurasi Konten Digital
            </h1>
            <p class="mt-2 text-lg text-slate-600">Direktorat SD 2025 - Pemantauan Hasil Kurasi</p>
        </header>

        <!-- Navigation Buttons -->
        <div class="flex flex-wrap items-center justify-start gap-3 mb-8 fade-in fade-in-delay-1">
            <a href="Kurator.html" class="flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-all transform hover:scale-105 hover:shadow-lg">
                <i class="fas fa-user-check mr-2"></i>
                <span>Kurator</span>
            </a>
            <a href="Admin.html" class="flex items-center justify-center bg-slate-700 hover:bg-slate-800 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-all transform hover:scale-105 hover:shadow-lg">
                <i class="fas fa-user-shield mr-2"></i>
                <span>Admin</span>
            </a>
            <a href="Supervisor.html" class="flex items-center justify-center bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-all transform hover:scale-105 hover:shadow-lg">
                <i class="fas fa-chalkboard-teacher mr-2"></i>
                <span>Supervisor</span>
            </a>
            <a href="Pass.html" class="flex items-center justify-center bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-all transform hover:scale-105 hover:shadow-lg">
                <i class="fas fa-key mr-2"></i>
                <span>Pass</span>
            </a>
            <!-- Tombol Baru untuk Analisis -->
            <button id="show-analysis-btn" class="flex items-center justify-center bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-all transform hover:scale-105 hover:shadow-lg">
                <i class="fas fa-chart-bar mr-2"></i>
                <span>Analisis</span>
            </button>
        </div>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: Stats & Chart -->
            <div class="lg:col-span-1 flex flex-col gap-8">
                <!-- Stat Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-6">
                    <div class="stat-card bg-white p-6 rounded-xl shadow-lg border border-slate-200 fade-in fade-in-delay-2">
                        <div class="flex items-center">
                            <div class="bg-blue-100 text-blue-600 rounded-full h-12 w-12 flex items-center justify-center">
                                <i class="fas fa-file-alt text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-slate-500 text-sm font-medium">Total Konten</p>
                                <p id="total-content" class="text-2xl font-bold text-slate-800">...</p>
                            </div>
                        </div>
                    </div>
                     <div class="stat-card bg-white p-6 rounded-xl shadow-lg border border-slate-200 fade-in fade-in-delay-3">
                        <div class="flex items-center">
                            <div class="bg-green-100 text-green-600 rounded-full h-12 w-12 flex items-center justify-center">
                                <i class="fas fa-check-double text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-slate-500 text-sm font-medium">Konten Terkurasi</p>
                                <p id="curated-content" class="text-2xl font-bold text-slate-800">...</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card bg-white p-6 rounded-xl shadow-lg border border-slate-200 fade-in fade-in-delay-4">
                        <div class="flex items-center">
                            <div class="bg-purple-100 text-purple-600 rounded-full h-12 w-12 flex items-center justify-center">
                                <i class="fas fa-users text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-slate-500 text-sm font-medium">Total Kurator</p>
                                <p id="total-kurator" class="text-2xl font-bold text-slate-800">...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Card -->
                <div class="stat-card bg-white p-6 rounded-xl shadow-lg border border-slate-200 fade-in fade-in-delay-5">
                    <h3 class="text-lg font-bold text-slate-700 mb-4">Progres Keseluruhan</h3>
                    <div class="relative h-60 w-full flex items-center justify-center">
                         <canvas id="curationChart"></canvas>
                         <div id="chart-percentage" class="absolute text-3xl font-extrabold text-slate-700">...</div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Progress Table -->
            <main class="lg:col-span-2 bg-white p-6 md:p-8 rounded-xl shadow-lg w-full border border-slate-200 fade-in fade-in-delay-5">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-700">Progres Kurasi per Individu</h2>
                    <p class="text-sm text-slate-500">Diperbarui: <span id="last-updated">...</span></p>
                </div>
                <div class="overflow-x-auto table-container border rounded-lg">
                    <table class="w-full text-left whitespace-nowrap">
                        <thead id="hasil-table-head" class="bg-slate-50">
                            <!-- Header akan digenerate oleh JavaScript -->
                        </thead>
                        <tbody id="hasil-table-body">
                            <tr>
                                <td colspan="13" class="text-center py-10">
                                    <div class="flex flex-col items-center text-slate-500">
                                        <i class="fas fa-spinner fa-spin text-2xl"></i>
                                        <p class="mt-2">Memuat data cache...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>
    
    <!-- === Analysis Modal === -->
    <div id="analysis-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl flex flex-col max-h-[80vh] transform transition-all duration-300 scale-95 opacity-0">
            <!-- Modal Header -->
            <div class="flex-shrink-0 p-5 flex justify-between items-center border-b border-slate-200">
                <h3 class="text-xl font-bold text-slate-800">Analisis Hasil Kurasi Rata-rata</h3>
                <button id="close-analysis-modal-btn" class="text-slate-500 hover:text-red-600 text-2xl w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-100 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <!-- Modal Body -->
            <div class="flex-grow p-6 overflow-y-auto">
                <div id="analysis-chart-container" class="space-y-3">
                    <div class="text-center text-slate-500 py-10">
                        <i class="fas fa-spinner fa-spin text-3xl"></i>
                        <p class="mt-3">Memuat data analisis lengkap...</p>
                    </div>
                </div>
            </div>
            <!-- Modal Footer -->
            <div class="flex-shrink-0 p-4 bg-slate-50 border-t border-slate-200 rounded-b-2xl flex justify-end items-center gap-3">
                 <a href="Analisis.html" class="flex items-center justify-center bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-all transform hover:scale-105">
                    <i class="fas fa-external-link-alt mr-2"></i>
                    <span>Buka Laman Analisis</span>
                </a>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

		const firebaseConfig = {
		  apiKey: "AIzaSyCOsQYueTyzUSmsY1H1P0k9nU1FtQCV__o",
		  authDomain: "kurasisd.firebaseapp.com",
		  projectId: "kurasisd",
		  storageBucket: "kurasisd.firebasestorage.app",
		  messagingSenderId: "520054778765",
		  appId: "1:520054778765:web:9c2d12e640a259b596ebc4"
		};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let curationChart;

        // --- Chart Initialization ---
        function initChart() {
            const ctx = document.getElementById('curationChart').getContext('2d');
            curationChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: ['Konten Selesai', 'Konten Sisa'], datasets: [{ data: [0, 1], backgroundColor: ['#22c55e', '#e2e8f0'], borderColor: '#ffffff', borderWidth: 4, hoverOffset: 8 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { legend: { display: false }, tooltip: { enabled: true } } }
            });
        }

        // --- UI Update Functions (from cache) ---
        function updateDashboardStats(cacheData) {
            document.getElementById('total-content').textContent = cacheData.totalContent || 0;
            document.getElementById('curated-content').textContent = cacheData.curatedContent || 0;
            document.getElementById('total-kurator').textContent = cacheData.totalKurator || 0;
            const percentage = (cacheData.totalContent || 0) > 0 ? ((cacheData.curatedContent || 0) / (cacheData.totalContent) * 100) : 0;
            document.getElementById('chart-percentage').textContent = `${percentage.toFixed(0)}%`;
            if (cacheData.lastUpdated) {
                document.getElementById('last-updated').textContent = new Date(cacheData.lastUpdated.seconds * 1000).toLocaleString('id-ID');
            }
            if (curationChart) {
                curationChart.data.datasets[0].data = [(cacheData.curatedContent || 0), (cacheData.totalContent || 0) - (cacheData.curatedContent || 0)];
                curationChart.update();
            }
        }

        function renderHasilTable(cacheData) {
            const thead = document.getElementById('hasil-table-head');
            const tbody = document.getElementById('hasil-table-body');
            thead.innerHTML = `<tr><th class="py-3 px-4 font-semibold text-slate-600 text-left sticky left-0 z-20 bg-slate-50">Nama Kurator</th>${Array.from({length: 12}, (_, i) => `<th class="py-3 px-4 font-semibold text-slate-600 text-center">Konten ${i+1}</th>`).join('')}</tr>`;
            const progressData = cacheData.progressTableData || [];
            if (progressData.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="13" class="text-center py-10 text-slate-500">Data progres belum tersedia.</td></tr>`; return;
            }
            tbody.innerHTML = progressData.map(curator => {
                let rowHTML = `<tr class="group border-b transition-colors duration-200 hover:bg-slate-50"><td class="py-3 px-4 font-medium text-slate-800 sticky left-0 z-10 bg-white group-hover:bg-slate-50">${curator.curatorName}</td>`;
                for (let i = 0; i < 12; i++) {
                    const status = curator.tasks[i];
                    if (status === 'completed') rowHTML += `<td class="py-2 px-4 text-center"><i class="fas fa-check-circle text-green-500" title="Selesai"></i></td>`;
                    else if (status === 'pending') rowHTML += `<td class="py-2 px-4 text-center"><i class="fas fa-times-circle text-slate-300" title="Belum Selesai"></i></td>`;
                    else rowHTML += `<td class="py-2 px-4 text-center text-slate-400">-</td>`;
                }
                return rowHTML + '</tr>';
            }).join('');
        }
        
        // --- Realtime Listener (Efficient Mode) ---
        onSnapshot(doc(db, "dashboard_cache", "summary_stats"), (snapshot) => {
            if (snapshot.exists()) {
                const cacheData = snapshot.data();
                updateDashboardStats(cacheData);
                renderHasilTable(cacheData);
            } else {
                console.error("Dokumen cache 'dashboard_cache/summary_stats' tidak ditemukan!");
                document.getElementById('hasil-table-body').innerHTML = `<tr><td colspan="13" class="text-center py-10 text-red-500"><strong>Error:</strong> Cache tidak ditemukan. Jalankan pembaruan cache dari halaman Admin.</td></tr>`;
            }
        });

        // --- Analysis Modal Logic (Optimized with Cache) ---
        function renderAnalysisChartFromCache(cacheData) {
            const stats = cacheData.stats || {};
            const totalContent = cacheData.totalContent || 0;
            const resultCategories = ["Lulus Kurasi", "Kurang Sesuai", "Perbaikan Minor", "Perbaikan Mayor", "Tidak Lulus Kurasi", "Belum Dinilai"];

            const container = document.getElementById('analysis-chart-container');
            if (totalContent === 0 || Object.values(stats).reduce((a,b) => a+b, 0) === 0) {
                container.innerHTML = `<p class="text-slate-500 text-center py-10">Tidak ada data analisis untuk ditampilkan.</p>`;
                return;
            }
            
            const colors = { "Lulus Kurasi": "bg-emerald-500", "Kurang Sesuai": "bg-sky-500", "Perbaikan Minor": "bg-amber-500", "Perbaikan Mayor": "bg-orange-600", "Tidak Lulus Kurasi": "bg-red-600", "Belum Dinilai": "bg-slate-400" };
            
            container.innerHTML = resultCategories.filter(cat => stats[cat] > 0).map(category => {
                const count = stats[category];
                const percentage = ((count / totalContent) * 100).toFixed(1);
                return `<div class="bar-item">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-slate-700">${category}</span>
                                <span class="text-sm font-bold text-slate-600">${count} dari ${totalContent} (${percentage}%)</span>
                            </div>
                            <div class="w-full bg-slate-200 rounded-full h-4 shadow-inner">
                                <div class="${colors[category] || 'bg-gray-500'} h-4 rounded-full" style="width: ${percentage}%;"></div>
                            </div>
                        </div>`;
            }).join('');
        }

        async function openAnalysisModal() {
            const modal = document.getElementById('analysis-modal');
            const modalContent = modal.querySelector('div');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => { modalContent.classList.remove('scale-95', 'opacity-0'); }, 10);

            const container = document.getElementById('analysis-chart-container');
            container.innerHTML = `<div class="text-center text-slate-500 py-10"><i class="fas fa-spinner fa-spin text-3xl"></i><p class="mt-3">Memuat data analisis...</p></div>`;

            try {
                const analysisCacheRef = doc(db, "dashboard_cache", "analysis_summary");
                const docSnap = await getDoc(analysisCacheRef);

                if (docSnap.exists()) {
                    renderAnalysisChartFromCache(docSnap.data());
                } else {
                    container.innerHTML = `<p class="text-orange-600 text-center py-10"><strong>Data Analisis Belum Ada</strong><br>Silakan perbarui cache dari Panel Admin untuk membuat laporan ini.</p>`;
                }
            } catch (error) {
                console.error("Gagal memuat data analisis:", error);
                container.innerHTML = `<p class="text-red-500 text-center py-10">Gagal memuat data. Periksa konsol untuk detailnya.</p>`;
            }
        }
        
        function closeAnalysisModal() {
            const modal = document.getElementById('analysis-modal');
            const modalContent = modal.querySelector('div');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300);
        }

        // --- Initial Load & Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            initChart();
            document.getElementById('show-analysis-btn').addEventListener('click', openAnalysisModal);
            document.getElementById('close-analysis-modal-btn').addEventListener('click', closeAnalysisModal);
        });

    </script>
</body>
</html>

