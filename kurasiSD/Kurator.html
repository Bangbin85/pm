<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Kurator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f8fafc; /* slate-50 */
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* slate-400 */
        }

        /* Modal Animations - Rombakan Total */
        @keyframes modal-backdrop-show { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modal-backdrop-hide { from { opacity: 1; } to { opacity: 0; } }
        @keyframes modal-content-show {
            from { opacity: 0; transform: translateY(30px) scale(0.97); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes modal-content-hide {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to { opacity: 0; transform: translateY(30px) scale(0.97); }
        }

        .modal-backdrop.show { animation: modal-backdrop-show 0.3s ease-out forwards; }
        .modal-backdrop.hide { animation: modal-backdrop-hide 0.3s ease-out forwards; }
        .modal-content.show { animation: modal-content-show 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .modal-content.hide { animation: modal-content-hide 0.3s ease-in forwards; }

        /* Custom Styles for a refined look */
        body {
            font-family: 'Inter', sans-serif;
        }

        .form-label { @apply block text-sm font-medium text-slate-700; }
        
        .form-input, .form-select, .form-textarea { 
            @apply block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 
                   focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 focus:border-indigo-500 
                   transition-all duration-150 sm:text-sm;
        }

        .card-hover { @apply transition-all duration-300 ease-in-out; }
        .card-hover:hover { @apply shadow-lg transform -translate-y-1; }

        /* New Curation Modal Specific Styles - Rombakan Navigasi */
        #modal-sidebar .sidebar-link {
            @apply flex items-center w-full text-left px-4 py-2.5 text-sm font-medium text-slate-600 rounded-lg transition-all duration-200;
        }
        #modal-sidebar .sidebar-link .link-icon {
            @apply w-5 h-5 flex-shrink-0 flex items-center justify-center text-lg mr-3 text-slate-500 transition-all duration-200;
        }
        #modal-sidebar .sidebar-link:hover {
            @apply bg-slate-200 text-slate-900;
        }
        #modal-sidebar .sidebar-link.active {
            @apply bg-indigo-600 text-white font-semibold shadow-md;
        }
        #modal-sidebar .sidebar-link.active .link-icon {
            @apply text-white;
        }
        .indicator-section {
            @apply pt-8;
        }
        .indicator-section + .indicator-section {
            @apply border-t border-slate-200;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- === LOGIN SECTION === -->
    <div id="login-section" class="flex items-center justify-center min-h-screen p-4 bg-slate-100">
        <div class="bg-white p-8 rounded-xl shadow-md w-full max-w-sm text-center border border-slate-200">
            <i class="fas fa-user-shield text-5xl text-indigo-500 mb-4"></i>
            <h1 class="text-2xl font-bold text-slate-800">Login Kurator</h1>
            <p class="text-slate-500 mb-6">Gunakan ID dan Password Anda.</p>
            <form id="login-form">
                <div class="w-full mb-4 text-left">
                    <label for="username-input" class="form-label">ID / Username</label>
                    <input type="text" id="username-input" class="form-input" placeholder="e.g., DirSD001" required>
                </div>
                <div class="w-full mb-6 text-left">
                    <label for="password-input" class="form-label">Password</label>
                    <input type="password" id="password-input" class="form-input" placeholder="••••••••" required>
                </div>
                 <p id="login-error" class="text-red-500 text-sm mb-4 hidden"></p>
                <button id="login-btn" type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-sm transition-all transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Masuk
                </button>
            </form>
        </div>
    </div>

    <!-- === MAIN DASHBOARD (HIDDEN BY DEFAULT) === -->
    <main id="main-dashboard" class="hidden">
        <header class="bg-white/80 backdrop-blur-lg shadow-sm sticky top-0 z-20 border-b border-slate-200">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 id="welcome-message" class="text-xl font-bold text-slate-800">Dashboard Kurator</h1>
                <button id="logout-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-lg text-sm transition-all duration-200">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </header>

        <div class="py-10">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <h2 class="text-xl font-semibold text-slate-700 mb-5 px-4 sm:px-0">Konten yang Ditugaskan:</h2>
                <div id="content-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cards will be loaded here -->
                </div>
            </div>
        </div>
    </main>
    
    <!-- === CURATION MODAL (HIDDEN BY DEFAULT) - Rombakan Total === -->
    <div id="curation-modal" class="fixed inset-0 bg-black bg-opacity-60 overflow-y-auto h-full w-full hidden z-50 p-4 flex items-center justify-center modal-backdrop">
        <div class="relative w-full max-w-7xl h-[95vh] bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden modal-content">
            <!-- Header -->
            <div class="flex-shrink-0 px-6 py-4 flex justify-between items-center border-b border-slate-200">
                <h3 class="text-lg font-semibold text-slate-900" id="curation-modal-title">Formulir Kurasi Konten</h3>
                <button id="close-modal-btn" class="text-slate-400 hover:text-red-500 hover:rotate-90 transition-all duration-300 text-3xl leading-none focus:outline-none">&times;</button>
            </div>
            
            <!-- Progress Bar -->
            <div class="flex-shrink-0 w-full bg-slate-100 h-1.5">
                <div id="curation-progress-bar" class="bg-indigo-500 h-1.5 rounded-r-full transition-all duration-300" style="width: 0%"></div>
            </div>
            
            <!-- Main Content -->
            <div class="flex-grow flex overflow-hidden">
                <!-- Sidebar - Rombakan Navigasi -->
                <nav id="modal-sidebar" class="w-72 flex-shrink-0 bg-slate-50 border-r border-slate-200 p-4 overflow-y-auto">
                    <!-- Sidebar links will be injected here -->
                </nav>

                <!-- Form Area -->
                <div id="modal-form-content" class="flex-grow p-8 overflow-y-auto">
                    <form id="curation-form" class="max-w-4xl mx-auto">
                        <!-- Dynamic form content will be injected here -->
                    </form>
                </div>
            </div>

             <!-- Footer -->
            <div class="flex-shrink-0 p-4 bg-white border-t border-slate-200 flex justify-end">
                <button type="submit" form="curation-form" id="submit-curation-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-sm transition-all transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i class="fas fa-check-circle mr-2"></i>Kirim Hasil Kurasi
                </button>
            </div>
        </div>
    </div>
    
    <!-- === Custom Alert / Confirmation Modal === -->
    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-60 h-full w-full hidden z-[100] p-4 items-center justify-center modal-backdrop">
         <div class="relative w-full max-w-md bg-white rounded-2xl shadow-2xl flex flex-col modal-content p-8 text-center">
            <h4 id="alert-modal-title" class="text-xl font-bold text-slate-800 mb-2">Title</h4>
            <p id="alert-modal-message" class="text-slate-600 mb-6">Message goes here.</p>
            <div id="alert-modal-buttons" class="flex gap-4 justify-center">
                <!-- Buttons are added dynamically -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, serverTimestamp, query, where, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyCOsQYueTyzUSmsY1H1P0k9nU1FtQCV__o",
            authDomain: "kurasisd.firebaseapp.com",
            projectId: "kurasisd",
            storageBucket: "kurasisd.firebasestorage.app",
            messagingSenderId: "520054778765",
            appId: "1:520054778765:web:9c2d12e640a259b596ebc4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- UI Elements ---
        const loginSection = document.getElementById('login-section');
        const mainDashboard = document.getElementById('main-dashboard');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const contentGrid = document.getElementById('content-grid');
        const curationModal = document.getElementById('curation-modal');
        const curationForm = document.getElementById('curation-form');
        const modalSidebar = document.getElementById('modal-sidebar');
        const modalFormContent = document.getElementById('modal-form-content');
        const progressBar = document.getElementById('curation-progress-bar');
        const alertModal = document.getElementById('alert-modal');

        let currentUser = null;

        // --- Curation Form Structure ---
        const curationQuestions = [
             { id: 'A1', title: 'A.1 Keamanan Materi', icon: 'fa-shield-halved', items: [ { id: 'radikalisme', text: 'Materi bebas dari unsur radikalisme, ekstremisme, dan terorisme' }, { id: 'pornografi', text: 'Materi bebas dari pornografi atau ketelanjangan yang tidak sesuai konteks' }, { id: 'diskriminasi', text: 'Materi bebas dari unsur perundungan atau diskriminasi' }, { id: 'promosi', text: 'Materi bebas dari promosi produk komersial' }, { id: 'sara', text: 'Materi bebas dari unsur SARA' }, { id: 'kekerasan', text: 'Materi bebas dari unsur kekerasan atau isu politik kontroversial' }, { id: 'komersial', text: 'Materi bebas dari unsur komersial (logo/identitas bisa diburamkan)' } ]},
             { id: 'A2', title: 'A.2 Copyright', icon: 'fa-copyright', items: [ { id: 'sumber', text: 'Mencantumkan sumber/referensi/credit' }, { id: 'ai', text: 'Jika dibuat oleh AI perlu dituliskan keterangan' } ]},
             { id: 'A3', title: 'A.3 Substansi Materi', icon: 'fa-book-open', items: [ { id: 'konsumsi', text: 'Materi dapat dikonsumsi langsung oleh murid' }, { id: 'mapel', text: 'Materi mendukung mata pelajaran secara spesifik' }, { id: 'kurikulum', text: 'Materi relevan dengan kurikulum yang berlaku' }, { id: 'akurat', text: 'Isi materi (visual, audio, dll) berisi informasi akurat' }, { id: 'sistematis', text: 'Materi disusun sistematis sesuai perkembangan kompetensi' }, { id: 'kesulitan', text: 'Tingkat kesulitan materi sesuai jenjang pendidikan' }, { id: 'asesmen', text: 'Materi memuat asesmen yang sesuai (bisa berupa pertanyaan reflektif)' }, ]},
             { id: 'A4', title: 'A.4 Kebahasaan', icon: 'fa-language', items: [ { id: 'sopan', text: 'Menggunakan bahasa yang sopan, baik, dan benar' }, { id: 'struktur', text: 'Struktur kalimat disesuaikan dengan tingkat pemahaman pengguna' }, ]},
             { id: 'A5', title: 'A.5 Inklusivitas', icon: 'fa-users-viewfinder', items: [ { id: 'bias', text: 'Materi bebas dari bias gender, sosial, ekonomi, dan budaya' }, { id: 'prinsip', text: 'Materi tidak bertentangan dengan prinsip inklusivitas' }, { id: 'akses', text: 'Materi dapat diakses oleh murid dengan berbagai kebutuhan' }, { id: 'ilustrasi', text: 'Ilustrasi mencerminkan keberagaman murid' }, ]},
             { id: 'B1', title: 'B.1 Teks', icon: 'fa-file-alt', items: [ { id: 'teks_kontras', text: 'Teks memiliki kontras yang tinggi dengan latar belakang' }, { id: 'teks_ilustrasi', text: 'Ilustrasi mendukung isi materi dengan teks sebagai elemen utama' }, { id: 'teks_resolusi', text: 'Ilustrasi memiliki resolusi yang baik' } ]},
             { id: 'B2', title: 'B.2 Gambar', icon: 'fa-image', items: [ { id: 'gambar_elemen_utama', text: 'Gambar sebagai elemen utama untuk mendukung pemahaman' }, { id: 'gambar_teks_pendukung', text: 'Teks berfungsi untuk mendukung isi materi' }, { id: 'gambar_kualitas', text: 'Gambar memiliki kualitas yang baik' }, { id: 'gambar_mudah_dipahami', text: 'Gambar mudah dipahami dan tidak multitafsir' }, { id: 'gambar_warna', text: 'Penggunaan warna penuh/hitam putih/gradasi sesuai' }, { id: 'gambar_kontras', text: 'Kontras warna tinggi dan latar belakang tidak mengganggu' } ]},
             { id: 'B3', title: 'B.3 Video', icon: 'fa-video', items: [ { id: 'video_musik', text: 'Musik latar (backsound) tidak mengganggu suara utama' }, { id: 'video_suara', text: 'Suara narator atau presenter jelas' }, { id: 'video_tulisan', text: 'Tulisan pada video terbaca dengan baik' }, { id: 'video_takarir', text: 'Takarir (jika ada) jelas dan sinkron' }, { id: 'video_visual', text: 'Visual terang, jelas, dan fokus' }, { id: 'video_skala', text: 'Video menggunakan skala 16:9' }, { id: 'video_resolusi', text: 'Resolusi minimum 720p' }, { id: 'video_kontras', text: 'Kontras warna tinggi dan latar belakang tidak ramai' }, { id: 'video_durasi', text: 'Durasi Video tidak terlalu panjang/pendek' } ]},
             { id: 'B4', title: 'B.4 Interaktif', icon: 'fa-mouse-pointer', items: [ { id: 'interaktif_relevansi', text: 'Konten interaktif relevan dengan materi' }, { id: 'interaktif_aktivitas', text: 'Aktivitas interaktif minimal (memilih, mencocokkan, dll)' }, { id: 'interaktif_navigasi', text: 'Materi mudah dinavigasi secara mandiri' }, { id: 'interaktif_visual', text: 'Visual jelas dan latar belakang tidak mengganggu' }, { id: 'interaktif_kontras', text: 'Kontras jelas antara teks, ikon, dan latar belakang' }, { id: 'interaktif_tombol', text: 'Tombol dan elemen interaktif ukurannya sesuai' }, { id: 'interaktif_ikon', text: 'Ikon dan warna konsisten' }, { id: 'interaktif_umpan_balik', text: 'Umpan balik langsung, jelas, dan mudah dipahami' }, { id: 'interaktif_ilustrasi', text: 'Ilustrasi relevan dan menarik minat murid' }, { id: 'interaktif_min_aktivitas', text: 'Memiliki minimal 3 aktivitas interaktif' } ]},
             { id: 'B5', title: 'B.5 Lab Maya', icon: 'fa-flask-vial', items: [ { id: 'lab_simulasi', text: 'Simulasi bersifat interaktif dua arah' }, { id: 'lab_umpan_balik_interaktif', text: 'Umpan balik interaktif ditampilkan secara langsung' }, { id: 'lab_navigasi', text: 'Navigasi intuitif dan memudahkan pengguna' }, { id: 'lab_desain', text: 'Desain antarmuka bersih dan terstruktur' }, { id: 'lab_umpan_balik_langsung', text: 'Umpan balik langsung, jelas, dan mudah dipahami' }, { id: 'lab_warna', text: 'Warna dan elemen visual selaras' }, { id: 'lab_tombol', text: 'Tombol, alat, dan indikator mudah dikenali' }, { id: 'lab_interaksi_dinamis', text: 'Interaksi dinamis dan drag-drop yang logis' }, { id: 'lab_pertanyaan_lanjutan', text: 'Pertanyaan lanjutan berbasis konteks' }, { id: 'lab_akses_kembali', text: 'Setiap tahapan dapat diakses kembali' }, { id: 'lab_indikator_progres', text: 'Tersedia indikator progres atau panduan langkah' } ]},
             { id: 'B6', title: 'B.6 Gim Edukasi', icon: 'fa-gamepad', items: [ { id: 'gim_navigasi', text: 'Navigasi permainan bersifat intuitif' }, { id: 'gim_aktivitas', text: 'Memuat aktivitas interaktif (drag-drop, fill-in-the-blank, dll)' }, { id: 'gim_respons', text: 'Setiap interaksi memberikan respons/umpan balik' }, { id: 'gim_elemen_visual', text: 'Elemen visual jelas, konsisten, dan kontras memadai' }, { id: 'gim_teks', text: 'Teks mudah dibaca dengan ukuran proporsional' }, { id: 'gim_animasi', text: 'Animasi dan efek visual digunakan secara proporsional' }, { id: 'gim_alur', text: 'Tersedia alur penyelesaian misi (pathway) yang jelas' }, { id: 'gim_indikator_progres', text: 'Tersedia indikator progres yang jelas' }, { id: 'gim_hasil_akhir', text: 'Hasil akhir dan skor ditampilkan secara informatif' }, { id: 'gim_efek_suara', text: 'Efek suara dan animasi memperkuat pengalaman interaktif' }, { id: 'gim_min_aktivitas', text: 'Memiliki minimal 3 aktivitas interaktif' } ]},
             { id: 'C1', title: 'C.1 Judul', icon: 'fa-heading', items: [ { id: 'judul_topik', text: 'Judul menggambarkan topik bahasan' }, { id: 'judul_kata_kunci', text: 'Memuat 1 - 3 kata kunci penting' }, { id: 'judul_kapitalisasi', text: 'Kapitalisasi judul sesuai kaidah tata bahasa' }, { id: 'judul_istilah', text: 'Istilah selaras dengan buku teks/kurikulum' }, { id: 'judul_ringkas', text: 'Ringkas, maksimal 55 karakter' } ]},
             { id: 'C2', title: 'C.2 Isi Materi', icon: 'fa-file-lines', items: [ { id: 'isi_langsung_digunakan', text: 'Berisi materi belajar yang bisa langsung digunakan murid' }, { id: 'isi_tanpa_info_kelas', text: 'Tidak ada informasi kelas dalam isi materi' } ]},
             { id: 'C3', title: 'C.3 Deskripsi', icon: 'fa-quote-left', items: [ { id: 'deskripsi_tujuan', text: 'Memuat tujuan belajar dan manfaat bagi murid' }, { id: 'deskripsi_bahasa', text: 'Bahasa baik, benar, dan mudah dipahami murid' }, { id: 'deskripsi_ringkas', text: 'Ringkas dan padat, 400-800 karakter' }, { id: 'deskripsi_tanpa_info_kelas', text: 'Tidak ada informasi kelas dalam deskripsi' }, { id: 'deskripsi_persuasif', text: 'Deskripsi persuasif dengan kata sapaan (adik-adik, kamu)' } ]},
             { id: 'C4', title: 'C.4 Penulis', icon: 'fa-user-pen', items: [ { id: 'penulis_nama', text: 'Nama penulis lengkap tanpa gelar' }, { id: 'penulis_kolaborasi', text: 'Jika kolaborasi, cantumkan satu nama utama' }, { id: 'penulis_instansi', text: 'Jika dari instansi, nama penulis bisa nama instansi' } ]},
             { id: 'C5', title: 'C.5 Prinsip Keselarasan', icon: 'fa-check-double', items: [ { id: 'keselarasan_prinsip', text: 'Keselarasan antara tujuan, langkah, dan asesmen pembelajaran' } ]}
        ];

        function buildCurationForm() {
            let formHTML = `<input type="hidden" id="curation-video-id"><input type="hidden" id="curation-user-id">`;
            let sidebarHTML = '<div class="space-y-1">';
            
            const allSections = [...curationQuestions, 
                { id: 'D1', title: 'D.1 Simpulan Umum', icon: 'fa-clipboard-check' }, 
                { id: 'D2', title: 'D.2 Keputusan Final', icon: 'fa-gavel' }
            ];

            const groupSeparators = ['B1', 'C1', 'D1'];

            allSections.forEach(group => {
                if (groupSeparators.includes(group.id)) {
                    sidebarHTML += `<div class="pt-2 pb-1"><hr class="border-slate-200"></div>`;
                }
                sidebarHTML += `
                    <a href="#group-${group.id}" class="sidebar-link" data-target="group-${group.id}">
                        <span class="link-icon"><i class="fas ${group.icon || 'fa-file'}"></i></span>
                        <span class="truncate">${group.title}</span>
                    </a>`;
            });
            sidebarHTML += '</div>';
            
            formHTML += curationQuestions.map(group => `
                <section id="group-${group.id}" class="indicator-section scroll-mt-8">
                    <header class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <div class="flex-grow">
                            <h3 class="text-xl font-bold text-slate-800">${group.title}</h3>
                            <p class="text-sm text-slate-500 mt-1">Pilih status dan berikan catatan untuk setiap poin di bawah.</p>
                        </div>
                        <div class="w-full md:w-auto md:min-w-[280px] mt-4 md:mt-0 flex-shrink-0">
                            <label for="select-${group.id}" class="form-label mb-1.5">Status Indikator</label>
                            <select id="select-${group.id}" class="form-select w-full" required>
                                <option value="">Pilih Nilai Indikator...</option>
                                <option value="Sesuai Sepenuhnya">Sesuai Sepenuhnya</option>
                                <option value="Sesuai dengan Catatan">Sesuai dengan Catatan</option>
                                <option value="Perlu Perbaikan">Perlu Perbaikan</option>
                                <option value="Tidak Sesuai">Tidak Sesuai</option>
                                <option value="N/A">Tidak Berlaku (N/A)</option>
                            </select>
                         </div>
                    </header>
                    <div class="mt-4 space-y-6">
                    ${(group.items || []).map(item => `
                        <div class="py-5 border-t border-slate-200 first:border-t-0 first:pt-0">
                            <label for="textarea-${group.id}-${item.id}" class="text-sm text-slate-700 font-medium mb-2 block">${item.text}</label>
                            <textarea id="textarea-${group.id}-${item.id}" rows="3" class="form-textarea w-full text-sm" placeholder="Catatan perbaikan atau justifikasi..."></textarea>
                        </div>
                    `).join('')}
                    </div>
                </section>
            `).join('');

            formHTML += `
                <section id="group-D1" class="indicator-section scroll-mt-8">
                    <header class="mb-6">
                        <h3 class="text-xl font-bold text-slate-800">D.1 Simpulan Umum</h3>
                        <p class="text-sm text-slate-500 mt-1">Berikan ringkasan dari hasil kurasi Anda.</p>
                    </header>
                    <div class="space-y-6 pt-6 border-t border-slate-200">
                        <div>
                            <label for="final-kelebihan" class="form-label font-semibold mb-1.5">Kelebihan Konten</label>
							<br>
                            <textarea id="final-kelebihan" rows="5" class="form-textarea w-full text-sm" placeholder="Contoh: Penjelasan materi sangat mudah dipahami..." required></textarea>
                        </div>
                        <div>
                            <label for="final-kekurangan" class="form-label font-semibold mb-1.5">Kekurangan Konten</label>
							<br>
                            <textarea id="final-kekurangan" rows="5" class="form-textarea w-full text-sm" placeholder="Contoh: Kualitas audio kurang jernih pada menit ke-2..." required></textarea>
                        </div>
                        <div>
                            <label for="final-saran" class="form-label font-semibold mb-1.5">Saran Perbaikan</label>
							<br>
                            <textarea id="final-saran" rows="5" class="form-textarea w-full text-sm" placeholder="Contoh: Sebaiknya audio diperbaiki dan ditambahkan takarir..." required></textarea>
                        </div>
                    </div>
                </section>
                 <section id="group-D2" class="indicator-section scroll-mt-8">
                    <header class="mb-6">
                        <h3 class="text-xl font-bold text-slate-800">D.2 Keputusan Final</h3>
                        <p class="text-sm text-slate-500 mt-1">Tentukan kelayakan konten berdasarkan analisis keseluruhan.</p>
                    </header>
                    <div class="space-y-6 pt-6 border-t border-slate-200">
                        <div>
                            <label for="final-keputusan" class="form-label font-semibold mb-1.5">Keputusan Final</label>
                            <select id="final-keputusan" class="form-select" required>
                                <option value="">Pilih Keputusan...</option>
                                <option value="Layak Tayang">Layak Tayang</option>
                                <option value="Layak dengan Revisi">Layak dengan Revisi</option>
                                <option value="Tidak Layak Tayang">Tidak Layak Tayang</option>
                            </select>
                        </div>
                        <div>
                             <label for="final-nilai-deskripsi" class="form-label font-semibold mb-1.5">Deskripsi Nilai Akhir</label>
							 <br>
                             <textarea id="final-nilai-deskripsi" class="form-textarea w-full text-sm" rows="5" placeholder="Tuliskan justifikasi untuk keputusan final Anda di sini..." required></textarea>
                        </div>
                    </div>
                </section>`;
            
            curationForm.innerHTML = formHTML;
            modalSidebar.innerHTML = sidebarHTML;
            setupSidebarNavigation();
            setupScrollObserver();
        }
        
        // --- Functions ---
        async function handleLogin(e) { e.preventDefault();
            const username = document.getElementById('username-input').value.trim();
            const password = document.getElementById('password-input').value;
            const loginBtn = document.getElementById('login-btn');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Mengecek...';
            loginError.classList.add('hidden');
            if (!username || !password) {
                loginError.textContent = 'Username dan Password harus diisi.';
                loginError.classList.remove('hidden');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Masuk';
                return;
            }
            try {
                const q = query(collection(db, "users"), where("username", "==", username));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) throw new Error("Username atau password salah.");
                const userDoc = querySnapshot.docs[0];
                const userData = userDoc.data();
                if (userData.password !== password) throw new Error("Username atau password salah.");
                localStorage.setItem('userId', userDoc.id);
                await displayUserDashboard(userDoc.id);
            } catch (error) {
                console.error("Login Gagal!", error);
                loginError.textContent = error.message;
                loginError.classList.remove('hidden');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Masuk';
            }
        }

        async function displayUserDashboard(userId) {
            loginSection.classList.add('hidden');
            mainDashboard.classList.remove('hidden');
            contentGrid.innerHTML = '<p class="text-slate-500 px-4 sm:px-0">Memuat konten...</p>';
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (!userDoc.exists()) throw new Error("User not found");
                currentUser = { id: userDoc.id, ...userDoc.data() };
                document.getElementById('welcome-message').textContent = `Selamat Bekerja, ${currentUser.nama}!`;
                const assignmentDoc = await getDoc(doc(db, 'assignments', currentUser.username));
                if (!assignmentDoc.exists() || !assignmentDoc.data().videoIds) {
                    contentGrid.innerHTML = '<p class="px-4 sm:px-0 text-slate-500">Tidak ada konten yang ditugaskan untuk Anda saat ini.</p>';
                    return;
                }
                const videoIds = assignmentDoc.data().videoIds;
                const curationsQuery = query(collection(db, "curations"), where("userId", "==", userId));
                const curationsSnapshot = await getDocs(curationsQuery);
                const curatedVideoIds = curationsSnapshot.docs.map(doc => doc.data().videoId);
                if (videoIds.length === 0) {
                     contentGrid.innerHTML = '<p class="px-4 sm:px-0 text-slate-500">Tidak ada konten yang ditugaskan untuk Anda saat ini.</p>';
                     return;
                }
                const videoPromises = videoIds.map(id => getDoc(doc(db, 'videos', id)));
                const videoDocs = await Promise.all(videoPromises);
                contentGrid.innerHTML = videoDocs.map(doc => {
                    if (!doc.exists()) return '';
                    const video = { id: doc.id, ...doc.data() };
                    const isCurated = curatedVideoIds.includes(video.id);
                    return `
                        <div class="bg-white rounded-lg shadow-sm overflow-hidden flex flex-col card-hover border border-slate-200">
                            <div class="p-5 flex-grow">
                                <p class="text-sm text-indigo-600 font-medium">${video.subject || 'Umum'}</p>
                                <h3 class="font-semibold text-lg text-slate-800 mt-1">${video.title}</h3>
                            </div>
                            <div class="p-4 bg-slate-50 grid grid-cols-2 gap-3 border-t border-slate-200">
                                <a href="${video.url}" target="_blank" rel="noopener noreferrer" class="text-center w-full font-bold py-2 px-4 rounded-md bg-white hover:bg-slate-100 text-slate-700 transition-all shadow-sm border border-slate-300">
                                    <i class="fas fa-external-link-alt mr-2 text-xs"></i>Buka
                                </a>
                                <button class="start-curation-btn w-full font-bold py-2 px-4 rounded-md transition-all shadow-sm
                                    ${isCurated ? 'bg-slate-200 text-slate-500 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 text-white'}"
                                    data-video-id="${video.id}" 
                                    data-video-title="${video.title}"
                                    ${isCurated ? 'disabled' : ''}>
                                    ${isCurated ? '<i class="fas fa-check-circle mr-2"></i>Selesai' : '<i class="fas fa-edit mr-2"></i>Kurasi'}
                                </button>
                            </div>
                        </div>`;
                }).join('');
            } catch (error) {
                console.error("Error displaying dashboard: ", error);
                contentGrid.innerHTML = `<p class="text-red-500 px-4 sm:px-0">Terjadi kesalahan: ${error.message}</p>`;
            }
        }
        
        // --- Modal & Navigation Logic ---
        function openCurationModal() {
            curationForm.reset();
            modalFormContent.scrollTop = 0; 
            const modalContent = curationModal.querySelector('.modal-content');
            curationModal.classList.remove('hidden');
            curationModal.classList.remove('hide');
            modalContent.classList.remove('hide');
            curationModal.classList.add('show');
            modalContent.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeCurationModal() {
            const modalContent = curationModal.querySelector('.modal-content');
            curationModal.classList.remove('show');
            modalContent.classList.remove('show');
            curationModal.classList.add('hide');
            modalContent.classList.add('hide');
            setTimeout(() => {
                curationModal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }, 300); 
        }

        function setupSidebarNavigation() {
            modalSidebar.addEventListener('click', (e) => {
                const link = e.target.closest('.sidebar-link');
                if (link) {
                    e.preventDefault();
                    const targetId = link.dataset.target;
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            });
        }
        
        function setupScrollObserver() {
            const observer = new IntersectionObserver((entries) => {
                let firstVisibleId = null;
                entries.forEach(entry => {
                    if (entry.isIntersecting && !firstVisibleId) {
                        firstVisibleId = entry.target.getAttribute('id');
                    }
                });

                if (firstVisibleId) {
                    modalSidebar.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                    const activeLink = modalSidebar.querySelector(`.sidebar-link[data-target="${firstVisibleId}"]`);
                    if (activeLink) activeLink.classList.add('active');
                }
                
                // Update progress bar
                const scrollableHeight = modalFormContent.scrollHeight - modalFormContent.clientHeight;
                const progress = scrollableHeight > 0 ? (modalFormContent.scrollTop / scrollableHeight) * 100 : 0;
                progressBar.style.width = `${progress}%`;

            }, { root: modalFormContent, threshold: 0.1, rootMargin: "-40% 0px -60% 0px" });

            curationForm.querySelectorAll('.indicator-section').forEach(section => {
                observer.observe(section);
            });
        }
        
        // --- Custom Alert/Confirm Modal Functionality ---
        function showConfirmation(title, message, onConfirm) {
            showAlert(title, message, [
                { text: 'Batal', class: 'bg-slate-200 hover:bg-slate-300 text-slate-800', callback: hideAlert },
                { text: 'Ya, Kirim', class: 'bg-indigo-600 hover:bg-indigo-700 text-white', callback: () => { hideAlert(); onConfirm(); } }
            ]);
        }

        function showAlert(title, message, buttons = [{ text: 'OK', class: 'bg-indigo-600 hover:bg-indigo-700 text-white', callback: hideAlert }]) {
            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-message').textContent = message;
            const buttonsContainer = document.getElementById('alert-modal-buttons');
            buttonsContainer.innerHTML = '';
            
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.textContent = btnInfo.text;
                button.className = `w-full font-bold py-2.5 px-4 rounded-lg transition-all duration-200 ${btnInfo.class}`;
                button.onclick = btnInfo.callback;
                buttonsContainer.appendChild(button);
            });

            const modalContent = alertModal.querySelector('.modal-content');
            alertModal.classList.remove('hidden');
            alertModal.classList.add('show');
            modalContent.classList.add('show');
        }

        function hideAlert() {
            const modalContent = alertModal.querySelector('.modal-content');
            alertModal.classList.remove('show');
            modalContent.classList.remove('show');
            alertModal.classList.add('hide');
            modalContent.classList.add('hide');
            setTimeout(() => {
                alertModal.classList.add('hidden');
            }, 200);
        }

        // --- Event Listeners ---
        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', () => { localStorage.removeItem('userId'); currentUser = null; mainDashboard.classList.add('hidden'); loginSection.classList.remove('hidden'); });
        
        document.body.addEventListener('click', (e) => {
            const startBtn = e.target.closest('.start-curation-btn');
            if (startBtn) {
                document.getElementById('curation-modal-title').textContent = `Kurasi Konten: ${startBtn.dataset.videoTitle}`;
                document.getElementById('curation-video-id').value = startBtn.dataset.videoId;
                document.getElementById('curation-user-id').value = currentUser.id;
                openCurationModal();
            }
        });

        document.getElementById('close-modal-btn').addEventListener('click', closeCurationModal);
        
        curationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-curation-btn');
            
            showConfirmation('Konfirmasi Pengiriman', 'Apakah Anda yakin ingin mengirim hasil kurasi ini? Data tidak dapat diubah setelah dikirim.', async () => {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...';

                try {
                    const answers = {};
                    curationQuestions.forEach(group => {
                        answers[group.id] = { 
                            value: document.getElementById(`select-${group.id}`).value, 
                            items: Object.fromEntries(group.items.map(item => [item.id, { notes: document.getElementById(`textarea-${group.id}-${item.id}`).value }]))
                        };
                    });
                    answers.D1_Simpulan_Umum = { kelebihan: document.getElementById('final-kelebihan').value, kekurangan: document.getElementById('final-kekurangan').value, saran: document.getElementById('final-saran').value };
                    answers.D2_Keputusan_Final = { keputusan: document.getElementById('final-keputusan').value, nilai_deskripsi: document.getElementById('final-nilai-deskripsi').value };
                    
                    const videoId = document.getElementById('curation-video-id').value;
                    const userId = document.getElementById('curation-user-id').value;
                    const curationDocId = `${userId}_${videoId}`;

                    await setDoc(doc(db, "curations", curationDocId), { userId, videoId, timestamp: serverTimestamp(), answers });
                    
                    closeCurationModal();
                    setTimeout(() => {
                        showAlert('Berhasil', 'Hasil kurasi telah berhasil disimpan.');
                        displayUserDashboard(currentUser.id);
                    }, 250)

                } catch (error) {
                    console.error("Error submitting curation: ", error);
                    showAlert('Gagal', 'Terjadi kesalahan saat menyimpan. Silakan coba lagi.');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Kirim Hasil Kurasi';
                }
            });
        });

        // Initialize App
        window.addEventListener('load', () => {
            buildCurationForm();
            const savedUserId = localStorage.getItem('userId');
            if (savedUserId) {
                displayUserDashboard(savedUserId);
            }
        });
    </script>
</body>
</html>

