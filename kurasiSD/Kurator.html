<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Kurator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
	<link rel="icon" type="image/x-icon" href="https://kemendikdasmen.go.id/web/image/website/21/favicon?unique=c3563e4">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* === TEMA MODERN & ANIMASI === */
        :root {
            --c-primary: #7c3aed; /* violet-600 */
            --c-primary-dark: #6d28d9; /* violet-700 */
            --c-primary-light: #a78bfa; /* violet-400 */
            --c-secondary: #3b82f6; /* blue-500 */
            --c-glow: rgba(124, 58, 237, 0.4);

            /* Variabel Gaya Neumorphism Baru */
            --neu-bg: #eef2ff;
            --neu-light-shadow: #ffffff;
            --neu-dark-shadow: #d4d9e9;
            --neu-text: #5b647c;
            --neu-radius-lg: 24px;
            --neu-radius-md: 16px;
            --neu-radius-sm: 12px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--neu-bg);
            color: var(--neu-text);
        }

        /* === Animasi Umum (Tetap Sama) === */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes popIn {
            0% { opacity: 0; transform: translateY(20px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes modal-backdrop-show { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modal-backdrop-hide { to { opacity: 0; } }
        @keyframes modal-content-show {
            from { opacity: 0; transform: translateY(50px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes modal-content-hide {
            to { opacity: 0; transform: translateY(50px) scale(0.95); }
        }
        @keyframes glow {
            0% { box-shadow: 0 0 5px var(--c-primary-light); }
            50% { box-shadow: 0 0 20px var(--c-primary-light); }
            100% { box-shadow: 0 0 5px var(--c-primary-light); }
        }

        .modal-backdrop.show { animation: modal-backdrop-show 0.3s ease-out forwards; }
        .modal-backdrop.hide { animation: modal-backdrop-hide 0.3s ease-out forwards; }
        .modal-content.show { animation: modal-content-show 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .modal-content.hide { animation: modal-content-hide 0.3s ease-in forwards; }

        /* === GAYA KOMPONEN (Diperbarui ke Neumorphism) === */

        /* Kartu Login */
        .login-card-container {
            opacity: 0;
            animation: fadeInDown 0.7s 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            background: var(--neu-bg);
            border-radius: var(--neu-radius-lg);
            box-shadow: 12px 12px 24px var(--neu-dark-shadow), -12px -12px 24px var(--neu-light-shadow);
            border: 1px solid rgba(255,255,255,0.5);
        }
        
        .login-card-container .bg-gradient-to-br { /* Tetap menjaga gradien pada sisi ilustrasi */
            border-radius: var(--neu-radius-lg) 0 0 var(--neu-radius-lg);
        }

        /* Kartu Konten */
        .content-card {
            opacity: 0; /* Mulai tersembunyi, diaktifkan oleh JS */
            animation: popIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            background: var(--neu-bg);
            border-radius: var(--neu-radius-md);
            box-shadow: 6px 6px 12px var(--neu-dark-shadow), -6px -6px 12px var(--neu-light-shadow);
            transition: all 0.3s ease-in-out;
        }
        .content-card:hover {
            transform: translateY(-2px);
            box-shadow: 8px 8px 16px var(--neu-dark-shadow), -8px -8px 16px var(--neu-light-shadow);
        }
        .content-card .p-4 {
            background-color: transparent;
        }

        /* Formulir dengan gaya Neumorphism Inset */
        .form-label { @apply block text-sm font-medium mb-1; color: var(--neu-text); }
        .form-input, .form-select, .form-textarea {
            @apply block w-full px-4 py-3 placeholder-slate-400 transition-all duration-300;
            background-color: var(--neu-bg);
            color: var(--neu-text);
            border: none;
            border-radius: var(--neu-radius-sm);
            box-shadow: inset 5px 5px 10px var(--neu-dark-shadow),
                        inset -5px -5px 10px var(--neu-light-shadow);
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            @apply outline-none ring-2 ring-offset-2;
            --tw-ring-color: var(--c-primary);
            --tw-ring-offset-color: var(--neu-bg);
            box-shadow: none; /* Hilangkan shadow saat fokus untuk kejelasan */
        }

        /* Tombol dengan gaya Neumorphism Raised */
        .btn {
            @apply font-bold py-2.5 px-5 rounded-xl transition-all duration-150 transform focus:outline-none text-center relative;
            background: var(--neu-bg);
            color: var(--neu-text);
            box-shadow: 5px 5px 10px var(--neu-dark-shadow), -5px -5px 10px var(--neu-light-shadow);
            border: none;
        }
        .btn:hover {
            filter: brightness(1.05);
        }
        .btn:active {
            box-shadow: inset 4px 4px 8px var(--neu-dark-shadow), inset -4px -4px 8px var(--neu-light-shadow);
            transform: translateY(1px);
            font-size: 0.98em;
            filter: brightness(1);
        }
        .btn.disabled, .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            box-shadow: inset 4px 4px 8px var(--neu-dark-shadow), inset -4px -4px 8px var(--neu-light-shadow);
        }

        .btn-primary {
            color: var(--c-primary);
            font-weight: 700;
        }
        
        #login-btn, #submit-curation-btn {
            background: var(--c-primary);
            color: white;
            box-shadow: 5px 5px 10px var(--c-primary-dark), -5px -5px 10px var(--c-primary-light);
        }
        #login-btn:active, #submit-curation-btn:active {
            box-shadow: inset 5px 5px 10px var(--c-primary-dark), inset -5px -5px 10px var(--c-primary-light);
        }

        .btn-secondary {
            color: var(--neu-text);
        }

        .btn-home {
            color: #16a34a; /* green-600 */
        }
    
        /* Modal Kurasi */
        .modal-content {
            background: var(--neu-bg);
            border-radius: var(--neu-radius-lg);
            box-shadow: 10px 10px 20px var(--neu-dark-shadow), -10px -10px 20px var(--neu-light-shadow);
        }
        #curation-progress-bar {
            animation: glow 2s linear infinite;
        }

        #modal-sidebar {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.75rem;
            align-content: start;
            padding: 1.5rem 1rem;
            border-right: 1px solid var(--neu-dark-shadow);
        }
        #modal-sidebar .sidebar-link {
            @apply flex items-center justify-center w-full text-center p-3 rounded-xl transition-all duration-300 ease-in-out font-bold text-lg;
            color: var(--neu-text);
            box-shadow: 4px 4px 8px var(--neu-dark-shadow), -4px -4px 8px var(--neu-light-shadow);
        }
        #modal-sidebar .sidebar-link:hover {
            color: var(--c-primary);
        }
        #modal-sidebar .sidebar-link.active {
            color: var(--c-primary);
            font-weight: 800;
            box-shadow: inset 4px 4px 8px var(--neu-dark-shadow), inset -4px -4px 8px var(--neu-light-shadow);
        }
        #modal-sidebar .sidebar-link-content { /* Kelas ini tidak lagi diperlukan untuk efek 3D */
            transform: none;
        }


        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--neu-bg); }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    </style>
</head>
<body class="text-slate-800">

    <!-- === BAGIAN LOGIN === -->
    <div id="login-section" class="flex items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="login-card-container w-full max-w-5xl mx-auto flex flex-col md:flex-row overflow-hidden">
            <!-- Kolom Kiri - Ilustrasi -->
            <div class="hidden md:flex flex-col justify-center items-center w-full md:w-1/2 p-10 lg:p-12 bg-gradient-to-br from-violet-500 to-blue-500 text-white">
                 <div class="text-center">
                    <i class="fas fa-book-reader text-7xl mb-6 opacity-80"></i>
                    <h2 class="text-3xl lg:text-4xl font-bold leading-tight">Panel Kurasi Konten</h2>
                    <p class="mt-4 text-violet-200 text-lg">Mewujudkan materi pembelajaran berkualitas untuk masa depan pendidikan Indonesia.</p>
                </div>
            </div>

            <!-- Kolom Kanan - Formulir -->
            <div class="w-full md:w-1/2 p-8 sm:p-12 flex flex-col justify-center">
                <div class="w-full max-w-md mx-auto">
                    <div class="text-center md:text-left mb-8">
                         <h1 class="text-3xl font-bold">Login Kurator</h1>
                         <p class="mt-2">Selamat datang kembali! Silakan masuk.</p>
                    </div>
                    <form id="login-form">
                        <div class="w-full mb-5">
                            <input type="text" id="username-input" class="form-input w-full" placeholder="Username, DirSD001" required>
                        </div>
                        <div class="w-full mb-6">
                            <input type="password" id="password-input" class="form-input w-full" placeholder="123**6" required>
                        </div>
                         <p id="login-error" class="text-red-500 text-sm mb-4 hidden"></p>
                        <div class="flex flex-col sm:flex-row gap-3 items-center">
                            <button id="login-btn" type="submit" class="btn w-full sm:w-auto flex-grow text-xl">
                                Masuk
                            </button>
                            <a href="./" class="btn btn-home w-full sm:w-auto">
                                <i class="fas fa-home mr-2"></i>Home
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- === DASBOR UTAMA (TERSEMBUNYI) === -->
    <main id="main-dashboard" class="hidden">
        <header class="bg-white/80 backdrop-blur-lg shadow-sm sticky top-0 z-20 border-b border-slate-200">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 id="welcome-message" class="text-xl font-bold text-slate-800">Dashboard Kurator</h1>
                <div class="flex items-center gap-4">
                    <a href="./" class="btn btn-home">
                        <i class="fas fa-home mr-2"></i>Home
                    </a>
                    <button id="logout-btn" class="btn btn-secondary">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </header>

        <div class="py-10">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <h2 class="text-2xl font-semibold text-slate-700 mb-6 px-4 sm:px-0">Konten yang Ditugaskan:</h2>
                <div id="content-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Kartu konten akan dimuat di sini oleh JavaScript -->
                </div>
            </div>
        </div>
    </main>
    
    <!-- === MODAL KURASI (TERSEMBUNYI) === -->
    <div id="curation-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm overflow-y-auto h-full w-full hidden z-50 p-4 items-center justify-center modal-backdrop">
        <div class="relative w-full max-w-7xl h-[95vh] flex flex-col overflow-hidden modal-content">
            <!-- Header -->
            <div class="flex-shrink-0 px-6 py-4 flex justify-between items-center border-b border-[var(--neu-dark-shadow)]">
                <h3 class="text-lg font-semibold" id="curation-modal-title">Formulir Kurasi Konten</h3>
                <button id="close-modal-btn" class="text-slate-500 hover:text-red-500 h-10 w-10 flex items-center justify-center transition-all duration-300 text-3xl leading-none focus:outline-none hover:rotate-90">&times;</button>
            </div>
            
            <!-- Progress Bar -->
            <div class="flex-shrink-0 w-full bg-slate-200 h-1.5">
                <div id="curation-progress-bar" class="bg-gradient-to-r from-violet-500 to-blue-500 h-1.5 rounded-r-full transition-all duration-300" style="width: 0%"></div>
            </div>
            
            <!-- Konten Utama -->
            <div class="flex-grow flex overflow-hidden">
                <!-- Sidebar -->
                <nav id="modal-sidebar" class="w-72 flex-shrink-0 overflow-y-auto">
                    <!-- Link sidebar akan disuntikkan di sini -->
                </nav>

                <!-- Area Formulir -->
                <div id="modal-form-content" class="flex-grow p-8 overflow-y-auto">
                    <form id="curation-form" class="max-w-4xl mx-auto">
                        <!-- Konten formulir dinamis akan disuntikkan di sini -->
                    </form>
                </div>
            </div>

             <!-- Footer -->
            <div class="flex-shrink-0 p-4 border-t border-[var(--neu-dark-shadow)] flex justify-between items-center">
                <span id="draft-status" class="text-sm italic"></span>
                <div class="flex gap-4">
                    <button type="button" id="save-draft-btn" class="btn btn-secondary text-base py-3 px-6">
                        <i class="fas fa-save mr-2"></i>Simpan Draft
                    </button>
                    <button type="submit" form="curation-form" id="submit-curation-btn" class="btn text-base py-3 px-6">
                        <i class="fas fa-check-circle mr-2"></i>Kirim Hasil Kurasi
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- === Modal Alert / Konfirmasi Kustom === -->
    <div id="alert-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm h-full w-full hidden z-[100] p-4 items-center justify-center modal-backdrop">
         <div class="relative w-full max-w-md flex flex-col modal-content p-8 text-center">
            <h4 id="alert-modal-title" class="text-xl font-bold mb-2">Judul</h4>
            <p id="alert-modal-message" class="mb-6">Pesan akan muncul di sini.</p>
            <div id="alert-modal-buttons" class="flex gap-4 justify-center">
                <!-- Tombol ditambahkan secara dinamis -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK (Tidak ada perubahan pada logika JavaScript) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, serverTimestamp, query, where, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyCOsQYueTyzUSmsY1H1P0k9nU1FtQCV__o",
            authDomain: "kurasisd.firebaseapp.com",
            projectId: "kurasisd",
            storageBucket: "kurasisd.firebasestorage.app",
            messagingSenderId: "520054778765",
            appId: "1:520054778765:web:9c2d12e640a259b596ebc4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Elemen UI ---
        const loginSection = document.getElementById('login-section');
        const mainDashboard = document.getElementById('main-dashboard');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const contentGrid = document.getElementById('content-grid');
        const curationModal = document.getElementById('curation-modal');
        const curationForm = document.getElementById('curation-form');
        const modalSidebar = document.getElementById('modal-sidebar');
        const modalFormContent = document.getElementById('modal-form-content');
        const progressBar = document.getElementById('curation-progress-bar');
        const alertModal = document.getElementById('alert-modal');
        const saveDraftBtn = document.getElementById('save-draft-btn');
        const draftStatus = document.getElementById('draft-status');

        let currentUser = null;

        // --- Struktur Formulir Kurasi ---
        const curationQuestions = [
             { id: 'A1', title: 'A.1 Keamanan Materi', icon: 'fa-shield-halved', items: [ { id: 'radikalisme', text: 'Materi bebas dari unsur radikalisme, ekstremisme, dan terorisme' }, { id: 'pornografi', text: 'Materi bebas dari pornografi atau ketelanjangan yang tidak sesuai konteks' }, { id: 'diskriminasi', text: 'Materi bebas dari unsur perundungan atau diskriminasi' }, { id: 'promosi', text: 'Materi bebas dari promosi produk komersial' }, { id: 'sara', text: 'Materi bebas dari unsur SARA' }, { id: 'kekerasan', text: 'Materi bebas dari unsur kekerasan atau isu politik kontroversial' }, { id: 'komersial', text: 'Materi bebas dari unsur komersial (logo/identitas bisa diburamkan)' } ]},
             { id: 'A2', title: 'A.2 Copyright', icon: 'fa-copyright', items: [ { id: 'sumber', text: 'Mencantumkan sumber/referensi/credit' }, { id: 'ai', text: 'Jika dibuat oleh AI perlu dituliskan keterangan' } ]},
             { id: 'A3', title: 'A.3 Substansi Materi', icon: 'fa-book-open', items: [ { id: 'konsumsi', text: 'Materi dapat dikonsumsi langsung oleh murid' }, { id: 'mapel', text: 'Materi mendukung mata pelajaran secara spesifik' }, { id: 'kurikulum', text: 'Materi relevan dengan kurikulum yang berlaku' }, { id: 'akurat', text: 'Isi materi (visual, audio, dll) berisi informasi akurat' }, { id: 'sistematis', text: 'Materi disusun sistematis sesuai perkembangan kompetensi' }, { id: 'kesulitan', text: 'Tingkat kesulitan materi sesuai jenjang pendidikan' }, { id: 'asesmen', text: 'Materi memuat asesmen yang sesuai (bisa berupa pertanyaan reflektif)' }, ]},
             { id: 'A4', title: 'A.4 Kebahasaan', icon: 'fa-language', items: [ { id: 'sopan', text: 'Menggunakan bahasa yang sopan, baik, dan benar' }, { id: 'struktur', text: 'Struktur kalimat disesuaikan dengan tingkat pemahaman pengguna' }, ]},
             { id: 'A5', title: 'A.5 Inklusivitas', icon: 'fa-users-viewfinder', items: [ { id: 'bias', text: 'Materi bebas dari bias gender, sosial, ekonomi, dan budaya' }, { id: 'prinsip', text: 'Materi tidak bertentangan dengan prinsip inklusivitas' }, { id: 'akses', text: 'Materi dapat diakses oleh murid dengan berbagai kebutuhan' }, { id: 'ilustrasi', text: 'Ilustrasi mencerminkan keberagaman murid' }, ]},
             { id: 'B1', title: 'B.1 Teks', icon: 'fa-file-alt', items: [ { id: 'teks_kontras', text: 'Teks memiliki kontras yang tinggi dengan latar belakang' }, { id: 'teks_ilustrasi', text: 'Ilustrasi mendukung isi materi dengan teks sebagai elemen utama' }, { id: 'teks_resolusi', text: 'Ilustrasi memiliki resolusi yang baik' } ]},
             { id: 'B2', title: 'B.2 Gambar', icon: 'fa-image', items: [ { id: 'gambar_elemen_utama', text: 'Gambar sebagai elemen utama untuk mendukung pemahaman' }, { id: 'gambar_teks_pendukung', text: 'Teks berfungsi untuk mendukung isi materi' }, { id: 'gambar_kualitas', text: 'Gambar memiliki kualitas yang baik' }, { id: 'gambar_mudah_dipahami', text: 'Gambar mudah dipahami dan tidak multitafsir' }, { id: 'gambar_warna', text: 'Penggunaan warna penuh/hitam putih/gradasi sesuai' }, { id: 'gambar_kontras', text: 'Kontras warna tinggi dan latar belakang tidak mengganggu' } ]},
             { id: 'B3', title: 'B.3 Video', icon: 'fa-video', items: [ { id: 'video_musik', text: 'Musik latar (backsound) tidak mengganggu suara utama' }, { id: 'video_suara', text: 'Suara narator atau presenter jelas' }, { id: 'video_tulisan', text: 'Tulisan pada video terbaca dengan baik' }, { id: 'video_takarir', text: 'Takarir (jika ada) jelas dan sinkron' }, { id: 'video_visual', text: 'Visual terang, jelas, dan fokus' }, { id: 'video_skala', text: 'Video menggunakan skala 16:9' }, { id: 'video_resolusi', text: 'Resolusi minimum 720p' }, { id: 'video_kontras', text: 'Kontras warna tinggi dan latar belakang tidak ramai' }, { id: 'video_durasi', text: 'Durasi Video tidak terlalu panjang/pendek' } ]},
             { id: 'B4', title: 'B.4 Interaktif', icon: 'fa-mouse-pointer', items: [ { id: 'interaktif_relevansi', text: 'Konten interaktif relevan dengan materi' }, { id: 'interaktif_aktivitas', text: 'Aktivitas interaktif minimal (memilih, mencocokkan, dll)' }, { id: 'interaktif_navigasi', text: 'Materi mudah dinavigasi secara mandiri' }, { id: 'interaktif_visual', text: 'Visual jelas dan latar belakang tidak mengganggu' }, { id: 'interaktif_kontras', text: 'Kontras jelas antara teks, ikon, dan latar belakang' }, { id: 'interaktif_tombol', text: 'Tombol dan elemen interaktif ukurannya sesuai' }, { id: 'interaktif_ikon', text: 'Ikon dan warna konsisten' }, { id: 'interaktif_umpan_balik', text: 'Umpan balik langsung, jelas, dan mudah dipahami' }, { id: 'interaktif_ilustrasi', text: 'Ilustrasi relevan dan menarik minat murid' }, { id: 'interaktif_min_aktivitas', text: 'Memiliki minimal 3 aktivitas interaktif' } ]},
             { id: 'B5', title: 'B.5 Lab Maya', icon: 'fa-flask-vial', items: [ { id: 'lab_simulasi', text: 'Simulasi bersifat interaktif dua arah' }, { id: 'lab_umpan_balik_interaktif', text: 'Umpan balik interaktif ditampilkan secara langsung' }, { id: 'lab_navigasi', text: 'Navigasi intuitif dan memudahkan pengguna' }, { id: 'lab_desain', text: 'Desain antarmuka bersih dan terstruktur' }, { id: 'lab_umpan_balik_langsung', text: 'Umpan balik langsung, jelas, dan mudah dipahami' }, { id: 'lab_warna', text: 'Warna dan elemen visual selaras' }, { id: 'lab_tombol', text: 'Tombol, alat, dan indikator mudah dikenali' }, { id: 'lab_interaksi_dinamis', text: 'Interaksi dinamis dan drag-drop yang logis' }, { id: 'lab_pertanyaan_lanjutan', text: 'Pertanyaan lanjutan berbasis konteks' }, { id: 'lab_akses_kembali', text: 'Setiap tahapan dapat diakses kembali' }, { id: 'lab_indikator_progres', text: 'Tersedia indikator progres atau panduan langkah' } ]},
             { id: 'B6', title: 'B.6 Gim Edukasi', icon: 'fa-gamepad', items: [ { id: 'gim_navigasi', text: 'Navigasi permainan bersifat intuitif' }, { id: 'gim_aktivitas', text: 'Memuat aktivitas interaktif (drag-drop, fill-in-the-blank, dll)' }, { id: 'gim_respons', text: 'Setiap interaksi memberikan respons/umpan balik' }, { id: 'gim_elemen_visual', text: 'Elemen visual jelas, konsisten, dan kontras memadai' }, { id: 'gim_teks', text: 'Teks mudah dibaca dengan ukuran proporsional' }, { id: 'gim_animasi', text: 'Animasi dan efek visual digunakan secara proporsional' }, { id: 'gim_alur', text: 'Tersedia alur penyelesaian misi (pathway) yang jelas' }, { id: 'gim_indikator_progres', text: 'Tersedia indikator progres yang jelas' }, { id: 'gim_hasil_akhir', text: 'Hasil akhir dan skor ditampilkan secara informatif' }, { id: 'gim_efek_suara', text: 'Efek suara dan animasi memperkuat pengalaman interaktif' }, { id: 'gim_min_aktivitas', text: 'Memiliki minimal 3 aktivitas interaktif' } ]},
             { id: 'C1', title: 'C.1 Judul', icon: 'fa-heading', items: [ { id: 'judul_topik', text: 'Judul menggambarkan topik bahasan' }, { id: 'judul_kata_kunci', text: 'Memuat 1 - 3 kata kunci penting' }, { id: 'judul_kapitalisasi', text: 'Kapitalisasi judul sesuai kaidah tata bahasa' }, { id: 'judul_istilah', text: 'Istilah selaras dengan buku teks/kurikulum' }, { id: 'judul_ringkas', text: 'Ringkas, maksimal 55 karakter' } ]},
             { id: 'C2', title: 'C.2 Isi Materi', icon: 'fa-file-lines', items: [ { id: 'isi_langsung_digunakan', text: 'Berisi materi belajar yang bisa langsung digunakan murid' }, { id: 'isi_tanpa_info_kelas', text: 'Tidak ada informasi kelas dalam isi materi' } ]},
             { id: 'C3', title: 'C.3 Deskripsi', icon: 'fa-quote-left', items: [ { id: 'deskripsi_tujuan', text: 'Memuat tujuan belajar dan manfaat bagi murid' }, { id: 'deskripsi_bahasa', text: 'Bahasa baik, benar, dan mudah dipahami murid' }, { id: 'deskripsi_ringkas', text: 'Ringkas dan padat, 400-800 karakter' }, { id: 'deskripsi_tanpa_info_kelas', text: 'Tidak ada informasi kelas dalam deskripsi' }, { id: 'deskripsi_persuasif', text: 'Deskripsi persuasif dengan kata sapaan (adik-adik, kamu)' } ]},
             { id: 'C4', title: 'C.4 Penulis', icon: 'fa-user-pen', items: [ { id: 'penulis_nama', text: 'Nama penulis lengkap tanpa gelar' }, { id: 'penulis_kolaborasi', text: 'Jika kolaborasi, cantumkan satu nama utama' }, { id: 'penulis_instansi', text: 'Jika dari instansi, nama penulis bisa nama instansi' } ]},
             { id: 'C5', title: 'C.5 Prinsip Keselarasan', icon: 'fa-check-double', items: [ { id: 'keselarasan_prinsip', text: 'Keselarasan antara tujuan, langkah, dan asesmen pembelajaran' } ]}
        ];

        function buildCurationForm() {
            let formHTML = `<input type="hidden" id="curation-content-id"><input type="hidden" id="curation-user-id">`;
            let sidebarHTML = ''; 
            
            const allSections = [...curationQuestions, 
                { id: 'D1', title: 'D.1 Simpulan Umum', icon: 'fa-clipboard-check' }, 
                { id: 'D2', title: 'D.2 Keputusan Final', icon: 'fa-gavel' }
            ];

            const groupSeparators = ['B1', 'C1', 'D1'];

            allSections.forEach(group => {
                if (groupSeparators.includes(group.id)) {
                    sidebarHTML += `<div class="col-span-3 pt-2 pb-1"><hr class="border-slate-300"></div>`;
                }
                
                const code = group.title.split(' ')[0];

                sidebarHTML += `
                    <a href="#group-${group.id}" class="sidebar-link" data-target="group-${group.id}">
                        <span class="sidebar-link-content">${code}</span>
                    </a>`;
            });
            
            formHTML += curationQuestions.map(group => `
                <section id="group-${group.id}" class="indicator-section scroll-mt-8">
                    <header class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <div class="flex-grow">
                            <h3 class="text-xl font-bold">${group.title}</h3>
                            <p class="text-sm mt-1">Pilih status dan berikan catatan untuk setiap poin di bawah.</p>
                        </div>
                        <div class="w-full md:w-auto md:min-w-[280px] mt-4 md:mt-0 flex-shrink-0">
                            <label for="select-${group.id}" class="form-label mb-1.5">Status Indikator</label>
                            <select id="select-${group.id}" class="form-select w-full" required>
                                <option value="">Nilai</option>
                                <option value="Lulus Kurasi">Lulus Kurasi</option>
                                <option value="Kurang Sesuai">Kurang Sesuai</option>
                                <option value="Perbaikan Minor">Perbaikan Minor</option>
                                <option value="Perbaikan Mayor">Perbaikan Mayor</option>
                                <option value="Tidak Lulus Kurasi">Tidak Lulus Kurasi</option>
                            </select>
                         </div>
                    </header>
                    <div class="mt-4 space-y-6">
                    ${(group.items || []).map(item => `
                        <div class="py-5 border-t border-[var(--neu-dark-shadow)] first:border-t-0 first:pt-0">
                            <label for="textarea-${group.id}-${item.id}" class="text-sm font-medium mb-2 block">${item.text}</label>
                            <textarea id="textarea-${group.id}-${item.id}" rows="3" class="form-textarea w-full text-sm" placeholder="Catatan perbaikan atau justifikasi..."></textarea>
                        </div>
                    `).join('')}
                    </div>
                </section>
            `).join('');

            formHTML += `
                <section id="group-D1" class="indicator-section scroll-mt-8">
                    <header class="mb-6">
                        <h3 class="text-xl font-bold">D.1 Simpulan Umum</h3>
                        <p class="text-sm mt-1">Berikan ringkasan dari hasil kurasi Anda.</p>
                    </header>
                    <div class="space-y-6 pt-6 border-t border-[var(--neu-dark-shadow)]">
                        <div>
                            <label for="final-kelebihan" class="form-label font-semibold mb-1.5">Kelebihan Konten</label>
                            <textarea id="final-kelebihan" rows="5" class="form-textarea w-full text-sm" placeholder="Contoh: Penjelasan materi sangat mudah dipahami..." required></textarea>
                        </div>
                        <div>
                            <label for="final-kekurangan" class="form-label font-semibold mb-1.5">Kekurangan Konten</label>
                            <textarea id="final-kekurangan" rows="5" class="form-textarea w-full text-sm" placeholder="Contoh: Kualitas audio kurang jernih pada menit ke-2..." required></textarea>
                        </div>
                        <div>
                            <label for="final-saran" class="form-label font-semibold mb-1.5">Saran Perbaikan</label>
                            <textarea id="final-saran" rows="5" class="form-textarea w-full text-sm" placeholder="Contoh: Sebaiknya audio diperbaiki dan ditambahkan takarir..." required></textarea>
                        </div>
                    </div>
                </section>
                 <section id="group-D2" class="indicator-section scroll-mt-8">
                    <header class="mb-6">
                        <h3 class="text-xl font-bold">D.2 Keputusan Final</h3>
                        <p class="text-sm mt-1">Tentukan kelayakan konten berdasarkan analisis keseluruhan.</p>
                    </header>
                    <div class="space-y-6 pt-6 border-t border-[var(--neu-dark-shadow)]">
                        <div>
                            <label for="final-keputusan" class="form-label font-semibold mb-1.5">Keputusan Final</label>
                            <select id="final-keputusan" class="form-select" required>
                                <option value="">Nilai Akhir</option>
                                <option value="Lulus Kurasi">Lulus Kurasi</option>
                                <option value="Kurang Sesuai">Kurang Sesuai</option>
                                <option value="Perbaikan Minor">Perbaikan Minor</option>
                                <option value="Perbaikan Mayor">Perbaikan Mayor</option>
                                <option value="Tidak Lulus Kurasi">Tidak Lulus Kurasi</option>
                            </select>
                        </div>
                        <div>
                             <label for="final-nilai-deskripsi" class="form-label font-semibold mb-1.5">Deskripsi Nilai Akhir</label>
                             <textarea id="final-nilai-deskripsi" class="form-textarea w-full text-sm" rows="5" placeholder="Tuliskan justifikasi untuk keputusan final Anda di sini..." required></textarea>
                        </div>
                    </div>
                </section>`;
            
            curationForm.innerHTML = formHTML;
            modalSidebar.innerHTML = sidebarHTML;
            setupSidebarNavigation();
            setupScrollObserver();
        }
        
        // --- Fungsi-fungsi ---
        async function handleLogin(e) { e.preventDefault();
            const username = document.getElementById('username-input').value.trim();
            const password = document.getElementById('password-input').value;
            const loginBtn = document.getElementById('login-btn');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Mengecek...';
            loginError.classList.add('hidden');
            if (!username || !password) {
                loginError.textContent = 'Username dan Password harus diisi.';
                loginError.classList.remove('hidden');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Masuk';
                return;
            }
            try {
                const q = query(collection(db, "users"), where("username", "==", username));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) throw new Error("Username atau password salah.");
                const userDoc = querySnapshot.docs[0];
                const userData = userDoc.data();
                if (userData.password !== password) throw new Error("Username atau password salah.");
                localStorage.setItem('userId', userDoc.id);
                await displayUserDashboard(userDoc.id);
            } catch (error) {
                console.error("Login Gagal!", error);
                loginError.textContent = error.message;
                loginError.classList.remove('hidden');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Masuk';
            }
        }

        async function displayUserDashboard(userId) {
            loginSection.classList.add('hidden');
            mainDashboard.classList.remove('hidden');
            contentGrid.innerHTML = '<p class="text-slate-500 px-4 sm:px-0 col-span-full">Memuat konten...</p>';
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (!userDoc.exists()) throw new Error("User not found");
                currentUser = { id: userDoc.id, ...userDoc.data() };
                document.getElementById('welcome-message').textContent = `Selamat Bekerja, ${currentUser.nama}!`;
                const assignmentDoc = await getDoc(doc(db, 'assignments', currentUser.username));
                
                if (!assignmentDoc.exists() || !assignmentDoc.data().contentIds) {
                    contentGrid.innerHTML = '<p class="px-4 sm:px-0 text-slate-500 col-span-full">Tidak ada konten yang ditugaskan untuk Anda saat ini.</p>';
                    return;
                }
                const contentIds = assignmentDoc.data().contentIds;
                
                // Ambil data kurasi yang sudah selesai dan draf sekaligus
                const curationsQuery = query(collection(db, "curations"), where("userId", "==", userId));
                const draftsQuery = query(collection(db, "curation_drafts"), where("userId", "==", userId));
                
                const [curationsSnapshot, draftsSnapshot] = await Promise.all([
                    getDocs(curationsQuery),
                    getDocs(draftsQuery)
                ]);

                const curatedContentIds = curationsSnapshot.docs.map(doc => doc.data().contentId);
                const draftedContentIds = draftsSnapshot.docs.map(doc => doc.data().contentId);

                if (contentIds.length === 0) {
                     contentGrid.innerHTML = '<p class="px-4 sm:px-0 text-slate-500 col-span-full">Tidak ada konten yang ditugaskan untuk Anda saat ini.</p>';
                     return;
                }

                const contentPromises = contentIds.map(id => getDoc(doc(db, 'contents', id)));
                const contentDocs = await Promise.all(contentPromises);
                
                contentGrid.innerHTML = contentDocs.map(doc => {
                    if (!doc.exists()) return '';
                    const content = { id: doc.id, ...doc.data() };
                    const isCurated = curatedContentIds.includes(content.id);
                    const hasDraft = draftedContentIds.includes(content.id);
                    
                    let buttonText = '<i class="fas fa-edit mr-2"></i>Kurasi';
                    let buttonClass = 'btn-primary';
                    if (isCurated) {
                        buttonText = '<i class="fas fa-check-circle mr-2"></i>Selesai';
                        buttonClass = 'disabled';
                    } else if (hasDraft) {
                        buttonText = '<i class="fas fa-file-alt mr-2"></i>Lanjutkan Draft';
                    }

                    return `
                        <div class="content-card flex flex-col">
                            <div class="p-6 flex-grow">
                                <p class="text-sm font-medium" style="color: var(--c-primary);">${content.subject || 'Umum'}</p>
                                <h3 class="font-semibold text-lg mt-1">${content.title}</h3>
                            </div>
                            <div class="p-4 grid grid-cols-2 gap-3 border-t border-[var(--neu-dark-shadow)]">
                                <a href="${content.url}" target="_blank" rel="noopener noreferrer" class="btn btn-secondary text-sm">
                                    <i class="fas fa-external-link-alt mr-2 text-xs"></i>Buka
                                </a>
                                <button class="start-curation-btn btn ${buttonClass} text-sm"
                                    data-content-id="${content.id}" 
                                    data-content-title="${content.title}"
                                    ${isCurated ? 'disabled' : ''}>
                                    ${buttonText}
                                </button>
                            </div>
                        </div>`;
                }).join('');

                // Terapkan animasi staggered setelah konten di-render
                const contentCards = contentGrid.querySelectorAll('.content-card');
                contentCards.forEach((card, index) => {
                    card.style.animationDelay = `${index * 100}ms`;
                });

            } catch (error) {
                console.error("Error displaying dashboard: ", error);
                contentGrid.innerHTML = `<p class="text-red-500 px-4 sm:px-0 col-span-full">Terjadi kesalahan: ${error.message}</p>`;
            }
        }
        
        // --- Logika Modal & Navigasi ---
        function getAnswersFromForm() {
            const answers = {};
            curationQuestions.forEach(group => {
                answers[group.id] = { 
                    value: document.getElementById(`select-${group.id}`).value, 
                    items: Object.fromEntries(group.items.map(item => [item.id, { notes: document.getElementById(`textarea-${group.id}-${item.id}`).value }]))
                };
            });
            answers.D1_Simpulan_Umum = { kelebihan: document.getElementById('final-kelebihan').value, kekurangan: document.getElementById('final-kekurangan').value, saran: document.getElementById('final-saran').value };
            answers.D2_Keputusan_Final = { keputusan: document.getElementById('final-keputusan').value, nilai_deskripsi: document.getElementById('final-nilai-deskripsi').value };
            return answers;
        }

        function populateFormWithDraft(draftData) {
            const { answers } = draftData;
            if (!answers) return;

            curationQuestions.forEach(group => {
                if (answers[group.id]) {
                    document.getElementById(`select-${group.id}`).value = answers[group.id].value || '';
                    group.items.forEach(item => {
                        if (answers[group.id].items && answers[group.id].items[item.id]) {
                            document.getElementById(`textarea-${group.id}-${item.id}`).value = answers[group.id].items[item.id].notes || '';
                        }
                    });
                }
            });

            if (answers.D1_Simpulan_Umum) {
                document.getElementById('final-kelebihan').value = answers.D1_Simpulan_Umum.kelebihan || '';
                document.getElementById('final-kekurangan').value = answers.D1_Simpulan_Umum.kekurangan || '';
                document.getElementById('final-saran').value = answers.D1_Simpulan_Umum.saran || '';
            }
             if (answers.D2_Keputusan_Final) {
                document.getElementById('final-keputusan').value = answers.D2_Keputusan_Final.keputusan || '';
                document.getElementById('final-nilai-deskripsi').value = answers.D2_Keputusan_Final.nilai_deskripsi || '';
            }
        }

        async function openCurationModal(contentId, contentTitle) {
            curationForm.reset();
            draftStatus.textContent = '';
            document.getElementById('curation-modal-title').textContent = `Kurasi Konten: ${contentTitle}`;
            document.getElementById('curation-content-id').value = contentId;
            document.getElementById('curation-user-id').value = currentUser.id;
            
            // Cek dan muat draf jika ada
            const curationDocId = `${currentUser.id}_${contentId}`;
            const draftDocRef = doc(db, "curation_drafts", curationDocId);
            const draftDocSnap = await getDoc(draftDocRef);
            if (draftDocSnap.exists()) {
                populateFormWithDraft(draftDocSnap.data());
                draftStatus.textContent = 'Draf sebelumnya telah dimuat.';
            }

            modalFormContent.scrollTop = 0; 
            const modalContent = curationModal.querySelector('.modal-content');
            curationModal.classList.remove('hidden');
            curationModal.classList.remove('hide');
            modalContent.classList.remove('hide');
            curationModal.classList.add('show');
            modalContent.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeCurationModal() {
            const modalContent = curationModal.querySelector('.modal-content');
            curationModal.classList.remove('show');
            modalContent.classList.remove('show');
            curationModal.classList.add('hide');
            modalContent.classList.add('hide');
            setTimeout(() => {
                curationModal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }, 300); 
        }

        function setupSidebarNavigation() {
            modalSidebar.addEventListener('click', (e) => {
                const link = e.target.closest('.sidebar-link');
                if (link) {
                    e.preventDefault();
                    const targetId = link.dataset.target;
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            });
        }
        
        function setupScrollObserver() {
            const observer = new IntersectionObserver((entries) => {
                let firstVisibleId = null;
                entries.forEach(entry => {
                    if (entry.isIntersecting && !firstVisibleId) {
                        firstVisibleId = entry.target.getAttribute('id');
                    }
                });

                if (firstVisibleId) {
                    modalSidebar.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                    const activeLink = modalSidebar.querySelector(`.sidebar-link[data-target="${firstVisibleId}"]`);
                    if (activeLink) activeLink.classList.add('active');
                }
                
                const scrollableHeight = modalFormContent.scrollHeight - modalFormContent.clientHeight;
                const progress = scrollableHeight > 0 ? (modalFormContent.scrollTop / scrollableHeight) * 100 : 100;
                progressBar.style.width = `${progress}%`;

            }, { root: modalFormContent, threshold: 0.1, rootMargin: "-40% 0px -60% 0px" });

            curationForm.querySelectorAll('.indicator-section').forEach(section => {
                observer.observe(section);
            });
        }
        
        function showConfirmation(title, message, onConfirm) {
            showAlert(title, message, [
                { text: 'Batal', class: 'btn-secondary', callback: hideAlert },
                { text: 'Ya, Lanjutkan', class: 'btn-primary', callback: () => { hideAlert(); onConfirm(); } }
            ]);
        }

        function showAlert(title, message, buttons = [{ text: 'OK', class: 'btn-primary', callback: hideAlert }]) {
            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-message').textContent = message;
            const buttonsContainer = document.getElementById('alert-modal-buttons');
            buttonsContainer.innerHTML = '';
            
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.textContent = btnInfo.text;
                button.className = `btn w-full ${btnInfo.class}`;
                button.onclick = btnInfo.callback;
                buttonsContainer.appendChild(button);
            });

            const modalContent = alertModal.querySelector('.modal-content');
            alertModal.classList.remove('hidden');
            alertModal.classList.add('show');
            modalContent.classList.add('show');
        }

        function hideAlert() {
            const modalContent = alertModal.querySelector('.modal-content');
            alertModal.classList.remove('show');
            modalContent.classList.remove('show');
            alertModal.classList.add('hide');
            modalContent.classList.add('hide');
            setTimeout(() => {
                alertModal.classList.add('hidden');
            }, 200);
        }

        // --- Event Listeners ---
        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', () => { localStorage.removeItem('userId'); currentUser = null; mainDashboard.classList.add('hidden'); loginSection.classList.remove('hidden'); });
        
        document.body.addEventListener('click', (e) => {
            const startBtn = e.target.closest('.start-curation-btn');
            if (startBtn && !startBtn.disabled) {
                openCurationModal(startBtn.dataset.contentId, startBtn.dataset.contentTitle);
            }
        });

        document.getElementById('close-modal-btn').addEventListener('click', closeCurationModal);
        
        saveDraftBtn.addEventListener('click', async () => {
            saveDraftBtn.disabled = true;
            saveDraftBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...';
            draftStatus.textContent = '';
            
            try {
                const answers = getAnswersFromForm();
                const contentId = document.getElementById('curation-content-id').value;
                const userId = document.getElementById('curation-user-id').value;
                const curationDocId = `${userId}_${contentId}`;

                await setDoc(doc(db, "curation_drafts", curationDocId), { userId, contentId, timestamp: serverTimestamp(), answers });
                
                draftStatus.textContent = `Draf disimpan pada ${new Date().toLocaleTimeString()}.`;
                await displayUserDashboard(currentUser.id); // Refresh dashboard to update button text
            } catch (error) {
                console.error("Error saving draft: ", error);
                draftStatus.textContent = 'Gagal menyimpan draf.';
            } finally {
                saveDraftBtn.disabled = false;
                saveDraftBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Simpan Draft';
            }
        });

        curationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-curation-btn');
            
            showConfirmation('Konfirmasi Pengiriman', 'Apakah Anda yakin ingin mengirim hasil kurasi ini? Data tidak dapat diubah setelah dikirim.', async () => {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...';

                try {
                    const answers = getAnswersFromForm();
                    const contentId = document.getElementById('curation-content-id').value;
                    const userId = document.getElementById('curation-user-id').value;
                    const curationDocId = `${userId}_${contentId}`;

                    // Simpan ke koleksi kurasi final
                    await setDoc(doc(db, "curations", curationDocId), { userId, contentId, timestamp: serverTimestamp(), answers });
                    
                    // Hapus draf jika ada
                    const draftDocRef = doc(db, "curation_drafts", curationDocId);
                    await deleteDoc(draftDocRef).catch(err => console.log("No draft to delete or error:", err));
                    
                    closeCurationModal();
                    setTimeout(() => {
                        showAlert('Berhasil', 'Hasil kurasi telah berhasil disimpan.');
                        displayUserDashboard(currentUser.id);
                    }, 250)

                } catch (error) {
                    console.error("Error submitting curation: ", error);
                    showAlert('Gagal', 'Terjadi kesalahan saat menyimpan. Silakan coba lagi.');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Kirim Hasil Kurasi';
                }
            });
        });

        // Inisialisasi Aplikasi
        window.addEventListener('load', () => {
            buildCurationForm();
            const savedUserId = localStorage.getItem('userId');
            if (savedUserId) {
                displayUserDashboard(savedUserId);
            }
        });
    </script>
</body>
</html>
