<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="https://lh3.googleusercontent.com/d/1_4llqCMNoBDmwDHsI7RYsCM6rSK5wEjw">
    <title>KKTP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
            overflow-x: hidden;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.25);
        }
        .sidebar-glass {
             background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-right: 1px solid rgba(229, 231, 235, 0.8);
        }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px;}
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideInLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .slide-in-up { animation: slideInUp 0.5s ease-out forwards; }
        .slide-in-left { animation: slideInLeft 0.5s ease-out forwards; }

        .page {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .page-container.hidden .page {
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
            position: absolute;
            width: 100%;
        }
        
        .btn-gradient {
            background-image: linear-gradient(to right, #4f46e5, #7c3aed);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(124, 58, 237, 0.25);
        }
        .btn-gradient:hover {
            background-position: 100% 0;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(124, 58, 237, 0.35);
        }
        
        .table-container {
            max-height: calc(100vh - 400px);
            overflow: auto;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
        }
        
        .animate-blob { animation: blob 7s infinite; }
        .animation-delay-2000 { animation-delay: -2s; }
        .animation-delay-4000 { animation-delay: -4s; }
        @keyframes blob {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10">
        <div class="absolute top-0 -left-4 w-72 h-72 bg-purple-300 rounded-full mix-blend-multiply filter blur-xl opacity-50 animate-blob"></div>
        <div class="absolute top-0 -right-4 w-72 h-72 bg-indigo-300 rounded-full mix-blend-multiply filter blur-xl opacity-50 animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-8 left-20 w-72 h-72 bg-pink-300 rounded-full mix-blend-multiply filter blur-xl opacity-50 animate-blob animation-delay-4000"></div>
    </div>

    <div id="modal-notifikasi" class="fixed top-5 right-5 z-50 opacity-0 transition-opacity pointer-events-none">
        <div id="modal-content" class="flex items-center p-4 rounded-lg shadow-lg text-white max-w-sm">
            <div id="modal-icon" class="mr-3"></div>
            <span id="modal-message" class="flex-grow"></span>
            <button id="modal-close" class="ml-4 font-bold text-xl leading-none">&times;</button>
        </div>
    </div>
    
    <div id="modal-konfirmasi" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md slide-in-up">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Konfirmasi Tindakan</h2>
            <p id="modal-konfirmasi-pesan" class="text-gray-600 mb-6">Apakah Anda yakin ingin melanjutkan tindakan ini?</p>
            <div class="flex justify-end gap-3">
                <button id="modal-konfirmasi-batal" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition">Batal</button>
                <button id="modal-konfirmasi-ya" class="px-6 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>


    <div id="app" class="flex h-screen">
        <aside class="w-80 h-screen p-6 sidebar-glass flex flex-col slide-in-left flex-shrink-0">
            <div class="text-center mb-10">
                <h1 class="text-2xl font-bold text-indigo-700">Generator KKTP</h1>
                <p class="text-sm text-gray-500">Menu Navigasi</p>
            </div>

            <div class="flex-grow overflow-y-auto pr-2 -mr-2">
                 <div class="space-y-2">
                     <button id="tombol-tutorial" class="w-full text-left flex items-center gap-3 bg-white/60 p-2 rounded-lg border border-transparent hover:border-indigo-400 transition-all duration-300 group">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                        <span class="font-medium text-gray-700">Tutorial</span>
                    </button>
                    <button id="tombol-info-umum" class="w-full text-left flex items-center gap-3 bg-white/60 p-2 rounded-lg border border-transparent hover:border-indigo-400 transition-all duration-300 group">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v12a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm3 0a1 1 0 00-1 1v1a1 1 0 001 1h4a1 1 0 001-1V5a1 1 0 00-1-1H8zM8 9a1 1 0 000 2h4a1 1 0 100-2H8z" /></svg>
                        <span class="font-medium text-gray-700">Informasi Umum</span>
                    </button>

                </div>

                <h2 class="text-lg font-semibold text-gray-800 my-4">Mata Pelajaran</h2>
                <form id="form-pelajaran" class="flex gap-2 mb-4">
                    <input type="text" id="namaPelajaran" placeholder="Pelajaran baru..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition" required>
                    <button type="submit" class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition transform hover:scale-105 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    </button>
                </form>
                <div id="daftar-pelajaran" class="space-y-2"></div>
            </div>
        </aside>

        <main class="flex-1 p-8 overflow-y-auto relative page-container">
            <div id="halaman-awal" class="page fade-in">
                <div class="glass-card p-8 rounded-2xl shadow-lg slide-in-up">
                    <h1 class="text-4xl font-bold text-gray-900 mb-2">Informasi Umum</h1>
                    <p class="text-gray-600 mb-8">Lengkapi data di bawah ini untuk memulai.</p>
                    <form id="form-info" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="text" id="namaSekolah" placeholder="Nama Sekolah" class="p-3 bg-white/60 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition" required>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="kelas" class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                <select id="kelas" class="w-full p-3 bg-white/60 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition"></select>
                            </div>
                            <div>
                                <label for="fase" class="block text-sm font-medium text-gray-700 mb-1">Fase</label>
                                <input type="text" id="fase" placeholder="Otomatis" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-200 cursor-not-allowed" readonly>
                            </div>
                        </div>
                        <input type="text" id="tahunAjaran" placeholder="Tahun Ajaran" class="p-3 bg-white/60 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition" required>
                        <input type="number" id="phone" placeholder="Nomor Telepon" class="p-3 bg-white/60 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                        <input type="text" id="namaKepsek" placeholder="Nama Kepala Sekolah" class="p-3 bg-white/60 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition" required>
                        <input type="number" id="nipKepsek" placeholder="NIP Kepala Sekolah" class="p-3 bg-white/60 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                        <input type="text" id="namaGuru" placeholder="Nama Guru" class="p-3 bg-white/60 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition" required>
                        <input type="number" id="nipGuru" placeholder="NIP Guru" class="p-3 bg-white/60 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                        <button type="submit" class="md:col-span-2 btn-gradient text-white font-bold py-3 px-6 rounded-lg">Simpan Informasi</button>
                    </form>
                </div>
                <div class="glass-card p-8 rounded-2xl shadow-lg slide-in-up mt-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Manajemen Data</h2>
                     <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <button id="tombol-backup" class="w-full bg-slate-700 text-white font-semibold py-3 px-4 rounded-lg hover:bg-slate-800 transition shadow-md transform hover:scale-105">Backup Data</button>
                        <label for="file-restore" class="w-full block bg-teal-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-teal-600 transition shadow-md text-center cursor-pointer transform hover:scale-105">Restore Data</label>
                        <input type="file" id="file-restore" class="hidden" accept=".json">
                        <button id="tombol-reset-semua" class="w-full bg-red-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-red-700 transition shadow-md transform hover:scale-105">Reset Semua Data</button>
                    </div>
                </div>
            </div>

            <div id="halaman-tabel" class="page hidden">
                 <div class="glass-card p-6 md:p-8 rounded-2xl shadow-lg h-full flex flex-col">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4 flex-shrink-0">
                        <button id="tombol-kembali" class="flex items-center gap-2 bg-white text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200 transition transform hover:scale-105 duration-300 shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                            Kembali
                        </button>
                        <div class="text-center md:text-right">
                            <h1 id="header-pelajaran" class="text-3xl font-bold text-gray-900"></h1>
                        </div>
                    </div>
                    
                    <div class="mb-4 border-b pb-4 bg-white/40 p-4 rounded-lg flex-shrink-0">
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-x-6 gap-y-3 text-sm text-gray-700">
                            <div><strong>Sekolah:</strong> <span id="header-sekolah" class="text-gray-600"></span></div>
                            <div><strong>Kelas:</strong> <span id="header-kelas" class="text-gray-600"></span></div>
                            <div><strong>Fase:</strong> <span id="header-fase" class="text-gray-600"></span></div>
                            <div><strong>Thn. Ajaran:</strong> <span id="header-tahun-ajaran" class="text-gray-600"></span></div>
                            <div><strong>Telepon:</strong> <span id="header-phone" class="text-gray-600"></span></div>
                            <div><strong>Kepala Sekolah:</strong> <span id="header-kepsek" class="text-gray-600"></span></div>
                            <div><strong>NIP Kepsek:</strong> <span id="header-nip-kepsek" class="text-gray-600"></span></div>
                            <div><strong>Guru:</strong> <span id="header-guru" class="text-gray-600"></span></div>
                            <div><strong>NIP Guru:</strong> <span id="header-nip-guru" class="text-gray-600"></span></div>
                        </div>
                    </div>

                    <div class="mb-4 p-4 border rounded-lg bg-white/40 grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-5 gap-4 items-center flex-shrink-0">
                        <button id="tombol-download-pdf" class="w-full bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition shadow-md transform hover:scale-105">Download PDF</button>
                        <button id="tombol-download-format" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition shadow-md transform hover:scale-105">Download Format</button>
                        <label for="file-impor" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition shadow-md text-center cursor-pointer transform hover:scale-105">Impor dari Excel</label>
                        <input type="file" id="file-impor" class="hidden" accept=".xlsx, .xls">
                        <button id="tombol-reset-halaman" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition shadow-md transform hover:scale-105">Reset Pelajaran Ini</button>
                    </div>

                    <div class="table-container flex-grow">
                        <table class="w-full min-w-[1200px] text-left" id="tabel-kriteria">
                            <thead class="bg-gray-200 sticky top-0 z-10">
                                <tr id="header-utama">
                                    <th class="p-3 font-semibold text-gray-700 align-middle" rowspan="2">Capaian Pembelajaran</th>
                                    <th class="p-3 font-semibold text-gray-700 align-middle" rowspan="2">Tujuan Pembelajaran</th>
                                    <th class="p-3 font-semibold text-gray-700 align-middle" rowspan="2">Materi</th>
                                    <th class="p-3 font-semibold text-gray-700 text-center" colspan="6">Kriteria Tujuan Pembelajaran</th>
                                    <th class="p-3 font-semibold text-gray-700 align-middle w-24 text-center" rowspan="2">Aksi</th>
                                </tr>
                                <tr id="header-kriteria" class="bg-gray-200"></tr>
                            </thead>
                            <tbody id="body-tabel" class="bg-white"></tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 flex flex-col sm:flex-row justify-between items-center gap-4 flex-shrink-0">
                        <button id="tombol-tambah-capaian" class="w-full sm:w-auto bg-blue-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-600 transition shadow-md transform hover:scale-105">Tambah Capaian</button>
                        <button id="tombol-simpan-tabel" class="w-full sm:w-auto btn-gradient text-white font-bold py-3 px-6 rounded-lg">Simpan Perubahan</button>
                    </div>
                </div>
            </div>

            <div id="halaman-tutorial" class="page hidden">
                <div class="glass-card p-8 rounded-2xl shadow-lg slide-in-up">
                    <h1 class="text-4xl font-bold text-gray-900 mb-4">Selamat Datang!</h1>
                    <p class="text-gray-600 mb-8">Berikut adalah panduan untuk menggunakan Aplikasi Generator KKTP.</p>
                    
                    <div class="space-y-6 text-gray-700">
                        <div>
                            <h2 class="text-2xl font-semibold border-b-2 border-indigo-200 pb-2 mb-3">1. Halaman Informasi Umum</h2>
                            <ul class="list-disc list-inside space-y-2">
                                <li>Isi semua data umum seperti nama sekolah, kelas, tahun ajaran, dan nama guru pada form yang tersedia.</li>
                                <li>Kolom <strong>Fase</strong> akan terisi otomatis berdasarkan kelas yang Anda pilih.</li>
                                <li>Setelah selesai, klik tombol <strong>Simpan Informasi</strong>. Data ini akan digunakan pada header dokumen PDF yang akan Anda cetak.</li>
                            </ul>
                        </div>
                        <div>
                            <h2 class="text-2xl font-semibold border-b-2 border-indigo-200 pb-2 mb-3">2. Manajemen Mata Pelajaran</h2>
                            <ul class="list-disc list-inside space-y-2">
                                <li>Di sidebar kiri, Anda akan melihat bagian <strong>Mata Pelajaran</strong>.</li>
                                <li>Untuk menambah pelajaran baru, ketik nama pelajaran di kolom input lalu tekan tombol <strong>+</strong> atau Enter.</li>
                                <li>Untuk mengedit nama pelajaran, cukup klik pada namanya, ubah, lalu klik di luar area input untuk menyimpan.</li>
                                <li>Untuk membuka tabel kriteria pelajaran, arahkan mouse ke nama pelajaran lalu klik tombol <strong>Buka</strong>.</li>
                                <li>Untuk menghapus pelajaran, klik ikon <strong>tong sampah</strong>.</li>
                            </ul>
                        </div>
                        <div>
                            <h2 class="text-2xl font-semibold border-b-2 border-indigo-200 pb-2 mb-3">3. Halaman Kriteria (Tabel Utama)</h2>
                            <ul class="list-disc list-inside space-y-2">
                                <li>Ini adalah halaman utama untuk mengisi data KKTP. Anda bisa mengisi Capaian Pembelajaran, Tujuan, Materi, dan 6 kolom kriteria.</li>
                                <li><strong>Menambah Capaian (Baris Baru)</strong>: Klik tombol <strong>Tambah Capaian</strong> di bagian bawah.</li>
                                <li><strong>Menambah Tujuan</strong>: Setiap capaian bisa memiliki beberapa tujuan. Klik tombol <strong>+</strong> hijau di kolom Aksi untuk menambah baris tujuan baru di bawah capaian yang sama.</li>
                                <li><strong>Menghapus Tujuan/Capaian</strong>: Klik ikon <strong>tong sampah</strong> merah di kolom Aksi. Jika itu adalah satu-satunya tujuan dalam capaian, maka seluruh baris capaian akan terhapus.</li>
                                <li><strong>Menyorot Kolom</strong>: Isi angka 1-6 pada kotak kecil di kolom Aksi untuk memberi sorotan warna hijau pada kolom kriteria yang menjadi target.</li>
                                <li>Jangan lupa klik <strong>Simpan Perubahan</strong> untuk menyimpan semua yang telah Anda ketik di tabel.</li>
                            </ul>
                        </div>
                        <div>
                            <h2 class="text-2xl font-semibold border-b-2 border-indigo-200 pb-2 mb-3">4. Ekspor, Impor, dan Cetak</h2>
                            <ul class="list-disc list-inside space-y-2">
                                <li><strong>Download PDF</strong>: Mencetak tabel yang sedang ditampilkan menjadi sebuah file PDF lengkap dengan kop dan tanda tangan.</li>
                                <li><strong>Download Format</strong>: Mengunduh data tabel saat ini sebagai file Excel (.xlsx). Ini berguna jika Anda ingin mengedit data secara offline.</li>
                                <li><strong>Impor dari Excel</strong>: Mengunggah file Excel (yang sesuai format) untuk mengisi tabel secara otomatis. Klik tombol, pilih file, dan tabel akan terisi. Perubahan akan tersimpan otomatis.</li>
                            </ul>
                        </div>
                        <div>
                            <h2 class="text-2xl font-semibold border-b-2 border-indigo-200 pb-2 mb-3">5. Backup, Restore, dan Reset</h2>
                            <ul class="list-disc list-inside space-y-2">
                                <li><strong>Backup Data (di Halaman Awal)</strong>: Mengunduh semua data aplikasi (info umum dan semua pelajaran) dalam satu file JSON. Simpan file ini di tempat yang aman.</li>
                                <li><strong>Restore Data (di Halaman Awal)</strong>: Mengembalikan data dari file backup. Semua data yang ada saat ini akan ditimpa. Halaman akan dimuat ulang setelah berhasil.</li>
                                <li><strong>Reset Pelajaran Ini (di Halaman Tabel)</strong>: Menghapus data tabel untuk pelajaran dan kelas yang sedang aktif saja, dan mengembalikannya ke data default (jika ada).</li>
                                <li><strong>Reset Semua Data (di Halaman Awal)</strong>: Menghapus total semua data aplikasi dan mengembalikannya ke kondisi seperti saat pertama kali dibuka.</li>
                            </ul>
                        </div>
                    </div>

                    <div class="mt-12 pt-6 border-t border-indigo-200">
                         <h3 class="text-xl font-semibold text-gray-800 mb-3">Informasi Pengembang</h3>
                         <div class="flex items-center gap-4">
                            <p class="text-lg text-gray-700">Bangbin</p>
                            <a href="https://wa.me/6281310051985" target="_blank" class="flex items-center gap-2 text-green-600 hover:text-green-700 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.487 5.235 3.487 8.413C23.998 18.667 18.664 24 12.107 24c-1.78.0-3.518-.44-5.115-1.251L.057 24zm4.965-6.201a6.57 6.57 0 0 0 1.831 1.263c.595.275 1.22.422 1.857.422 4.931 0 8.94-4.009 8.941-8.941.0-2.42-.953-4.708-2.64-6.398-1.688-1.688-3.978-2.64-6.398-2.64-4.93 0-8.94 4.01-8.94 8.941 0 1.764.513 3.485 1.431 5.003l.31.488-1.03 3.793 3.89-1.019.458.275z"/></svg>
                                <span>WhatsApp</span>
                            </a>
                         </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="Database.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMEN DOM ---
            const halamanAwal = document.getElementById('halaman-awal');
            const halamanTabel = document.getElementById('halaman-tabel');
            const halamanTutorial = document.getElementById('halaman-tutorial');
            const pages = document.querySelectorAll('.page');

            const formInfo = document.getElementById('form-info');
            const formPelajaran = document.getElementById('form-pelajaran');
            const daftarPelajaranContainer = document.getElementById('daftar-pelajaran');
            const tombolKembali = document.getElementById('tombol-kembali');
            const tombolInfoUmum = document.getElementById('tombol-info-umum');
            const tombolTutorial = document.getElementById('tombol-tutorial');
            const tombolTambahCapaian = document.getElementById('tombol-tambah-capaian');
            const tombolSimpanTabel = document.getElementById('tombol-simpan-tabel');
            const bodyTabel = document.getElementById('body-tabel');
            const headerKriteria = document.getElementById('header-kriteria');
            const tombolBackup = document.getElementById('tombol-backup');
            const fileRestoreInput = document.getElementById('file-restore');
            const kelasSelect = document.getElementById('kelas');
            const tombolDownloadFormat = document.getElementById('tombol-download-format');
            const fileImporInput = document.getElementById('file-impor');
            const tombolDownloadPdf = document.getElementById('tombol-download-pdf');
            const tombolResetSemua = document.getElementById('tombol-reset-semua');
            const tombolResetHalaman = document.getElementById('tombol-reset-halaman');
            
            // Modal Notifikasi
            const modalNotifikasi = document.getElementById('modal-notifikasi');
            const modalContent = document.getElementById('modal-content');
            const modalIcon = document.getElementById('modal-icon');
            const modalMessage = document.getElementById('modal-message');
            const modalClose = document.getElementById('modal-close');
            let modalTimeout;

            // Modal Konfirmasi
            const modalKonfirmasi = document.getElementById('modal-konfirmasi');
            const modalKonfirmasiPesan = document.getElementById('modal-konfirmasi-pesan');
            const modalKonfirmasiYa = document.getElementById('modal-konfirmasi-ya');
            const modalKonfirmasiBatal = document.getElementById('modal-konfirmasi-batal');
            let onConfirmAction = null;

            let pelajaranAktif = null;

            // --- SISTEM NOTIFIKASI ---
            const showModal = (message, isSuccess = true) => {
                clearTimeout(modalTimeout);
                modalMessage.textContent = message;
                const successIcon = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                const errorIcon = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                if (isSuccess) {
                    modalContent.classList.remove('bg-red-500');
                    modalContent.classList.add('bg-green-500');
                    modalIcon.innerHTML = successIcon;
                } else {
                    modalContent.classList.remove('bg-green-500');
                    modalContent.classList.add('bg-red-500');
                    modalIcon.innerHTML = errorIcon;
                }
                modalNotifikasi.classList.remove('opacity-0', 'pointer-events-none');
                modalTimeout = setTimeout(() => {
                    modalNotifikasi.classList.add('opacity-0', 'pointer-events-none');
                }, 3000);
            };
            modalClose.addEventListener('click', () => {
                clearTimeout(modalTimeout);
                modalNotifikasi.classList.add('opacity-0', 'pointer-events-none');
            });

            // --- SISTEM MODAL KONFIRMASI ---
            const showKonfirmasiModal = (message, callback) => {
                modalKonfirmasiPesan.textContent = message;
                onConfirmAction = callback;
                modalKonfirmasi.classList.remove('hidden');
            };
            const hideKonfirmasiModal = () => {
                modalKonfirmasi.classList.add('hidden');
                onConfirmAction = null;
            };
            modalKonfirmasiYa.addEventListener('click', () => {
                if (typeof onConfirmAction === 'function') {
                    onConfirmAction();
                }
                hideKonfirmasiModal();
            });
            modalKonfirmasiBatal.addEventListener('click', hideKonfirmasiModal);

            // --- SISTEM NAVIGASI HALAMAN ---
            const tampilkanHalaman = (halamanId) => {
                pages.forEach(page => {
                    if (page.id !== halamanId) {
                        page.classList.add('hidden');
                    }
                });
                const halamanAktif = document.getElementById(halamanId);
                if (halamanAktif) {
                    halamanAktif.classList.remove('hidden');
                    halamanAktif.classList.add('fade-in');
                }
                pelajaranAktif = null; // Reset pelajaran aktif saat ganti halaman utama
            };


            // --- DATA DEFAULT ---
            const getDefaultKriteriaHeaders = () => ['Prastruktural', 'Belum Berkembang', 'Mulai Berkembang', 'Berkembang Sesuai Harapan', 'Mahir', ''];
            const getDefaultCapaianItem = () => ({
                capaian: '',
                tujuanList: [{ tujuan: '', materi: '', kriteria: Array(6).fill(''), highlightIndex: 3 }]
            });

            // --- FUNGSI RENDER & HELPER ---
            const updateFase = () => {
                const faseInput = document.getElementById('fase');
                const kelas = parseInt(kelasSelect.value, 10);
                let fase = '';
                if (kelas >= 1 && kelas <= 2) fase = 'A';
                else if (kelas >= 3 && kelas <= 4) fase = 'B';
                else if (kelas >= 5 && kelas <= 6) fase = 'C';
                else if (kelas >= 7 && kelas <= 9) fase = 'D';
                else if (kelas === 10) fase = 'E';
                else if (kelas >= 11 && kelas <= 12) fase = 'F';
                faseInput.value = fase;
            };
            const populateKelasDropdown = () => {
                for (let i = 1; i <= 12; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    kelasSelect.appendChild(option);
                }
            };
            const renderDaftarPelajaran = () => {
                const data = Database.getData();
                daftarPelajaranContainer.innerHTML = '';
                if (data.pelajaran.length === 0) {
                    daftarPelajaranContainer.innerHTML = '<p class="text-gray-500 text-center text-sm">Belum ada pelajaran.</p>';
                    return;
                }
                data.pelajaran.forEach(namaPelajaran => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center bg-white/60 p-2 rounded-lg border border-transparent hover:border-indigo-400 transition-all duration-300 group';
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = namaPelajaran;
                    input.className = 'flex-grow bg-transparent focus:outline-none text-gray-700 font-medium w-0';
                    input.dataset.oldName = namaPelajaran;
                    input.addEventListener('blur', editPelajaran);

                    const buttonGroup = document.createElement('div');
                    buttonGroup.className = 'flex items-center gap-1 flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity';
                    
                    const openBtn = document.createElement('button');
                    openBtn.textContent = 'Buka';
                    openBtn.className = 'bg-indigo-500 text-white text-xs font-semibold py-1 px-2 rounded-md hover:bg-indigo-600 transition transform hover:scale-105 duration-200';
                    openBtn.onclick = () => bukaHalamanTabel(input.value);
                    
                    const tombolHapus = document.createElement('button');
                    tombolHapus.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>`;
                    tombolHapus.className = 'bg-red-500 text-white p-1.5 rounded-md hover:bg-red-600 transition transform hover:scale-105 duration-200';
                    tombolHapus.onclick = () => hapusPelajaran(namaPelajaran);
                    
                    div.appendChild(input);
                    buttonGroup.appendChild(openBtn);
                    buttonGroup.appendChild(tombolHapus);
                    div.appendChild(buttonGroup);

                    daftarPelajaranContainer.appendChild(div);
                });
            };
            const renderInfoForm = () => {
                const data = Database.getData();
                document.getElementById('namaSekolah').value = data.info.namaSekolah || '';
                kelasSelect.value = data.info.kelas || '1';
                document.getElementById('tahunAjaran').value = data.info.tahunAjaran || '';
                document.getElementById('phone').value = data.info.phone || '';
                document.getElementById('namaKepsek').value = data.info.namaKepsek || '';
                document.getElementById('nipKepsek').value = data.info.nipKepsek || '';
                document.getElementById('namaGuru').value = data.info.namaGuru || '';
                document.getElementById('nipGuru').value = data.info.nipGuru || '';
                updateFase();
            };
            const bukaHalamanTabel = (namaPelajaran) => {
                pelajaranAktif = namaPelajaran;
                tampilkanHalaman('halaman-tabel');

                const data = Database.getData();
                const info = data.info;
                document.getElementById('header-pelajaran').textContent = `${namaPelajaran}`;
                document.querySelectorAll('#header-sekolah').forEach(el => el.textContent = info.namaSekolah || '-');
                document.querySelectorAll('#header-kelas').forEach(el => el.textContent = info.kelas || '-');
                document.querySelectorAll('#header-fase').forEach(el => el.textContent = info.fase || '-');
                document.querySelectorAll('#header-tahun-ajaran').forEach(el => el.textContent = info.tahunAjaran || '-');
                document.querySelectorAll('#header-phone').forEach(el => el.textContent = info.phone || '-');
                document.querySelectorAll('#header-kepsek').forEach(el => el.textContent = info.namaKepsek || '-');
                document.querySelectorAll('#header-nip-kepsek').forEach(el => el.textContent = info.nipKepsek || '-');
                document.querySelectorAll('#header-guru').forEach(el => el.textContent = info.namaGuru || '-');
                document.querySelectorAll('#header-nip-guru').forEach(el => el.textContent = info.nipGuru || '-');
                
                const currentKelasKey = `kelas_${data.info.kelas}`;
                if (data.kriteria[namaPelajaran] && data.kriteria[namaPelajaran][currentKelasKey]) {
                    renderTabelKriteria(data.kriteria[namaPelajaran][currentKelasKey]);
                } else {
                    const curriculumData = Database.getDefaultCurriculumData(data.info.kelas, namaPelajaran);
                    if (curriculumData) {
                        renderTabelKriteria(curriculumData);
                    } else {
                        renderTabelKriteria({ headers: getDefaultKriteriaHeaders(), rows: [] });
                    }
                }
            };
            const renderTabelKriteria = (kriteriaData) => {
                const rowsToRender = kriteriaData.rows;
                headerKriteria.innerHTML = '';
                kriteriaData.headers.forEach(headerText => {
                    const th = document.createElement('th');
                    th.className = 'p-1 font-semibold text-gray-700';
                    th.innerHTML = `<input type="text" class="w-full bg-transparent text-center font-semibold focus:outline-none" value="${headerText}">`;
                    headerKriteria.appendChild(th);
                });
                bodyTabel.innerHTML = '';
                if (!rowsToRender || rowsToRender.length === 0) {
                    rowsToRender.push(getDefaultCapaianItem());
                }
                rowsToRender.forEach((capaianItem, capaianIndex) => {
                    capaianItem.tujuanList.forEach((tujuanItem, tujuanIndex) => {
                        const tr = document.createElement('tr');
                        tr.className = 'border-b even:bg-gray-50/70 hover:bg-indigo-50/70';
                        tr.dataset.capaianIndex = capaianIndex;
                        tr.dataset.tujuanIndex = tujuanIndex;
                        let kriteriaHTML = '';
                        for (let i = 0; i < 6; i++) {
                            const isHighlighted = (i + 1) === tujuanItem.highlightIndex;
                            kriteriaHTML += `<td class="p-2 kriteria-cell ${isHighlighted ? 'bg-green-200' : ''}"><textarea class="w-full p-2 border rounded-md bg-transparent focus:bg-white focus:ring-1 focus:ring-indigo-400 transition" rows="3">${tujuanItem.kriteria[i] || ''}</textarea></td>`;
                        }
                        let rowHTML = '';
                        if (tujuanIndex === 0) {
                            rowHTML += `<td class="p-2 align-top capaian-cell" rowspan="${capaianItem.tujuanList.length}"><textarea class="w-full h-full p-2 border rounded-md bg-transparent focus:bg-white focus:ring-1 focus:ring-indigo-400 transition" rows="${capaianItem.tujuanList.length * 4}">${capaianItem.capaian}</textarea></td>`;
                        }
                        rowHTML += `
                            <td class="p-2"><textarea class="w-full p-2 border rounded-md bg-transparent focus:bg-white focus:ring-1 focus:ring-indigo-400 transition" rows="3">${tujuanItem.tujuan}</textarea></td>
                            <td class="p-2"><textarea class="w-full p-2 border rounded-md bg-transparent focus:bg-white focus:ring-1 focus:ring-indigo-400 transition" rows="3">${tujuanItem.materi}</textarea></td>
                            ${kriteriaHTML}
                            <td class="p-2 text-center align-middle">
                                <div class="flex flex-col items-center gap-2">
                                    <input type="number" min="1" max="6" title="Sorot kolom kriteria" class="highlight-input w-14 text-center border rounded p-1 mb-1 focus:ring-1 focus:ring-indigo-400" value="${tujuanItem.highlightIndex || ''}">
                                    <div class="flex gap-2">
                                        <button title="Tambah Tujuan" class="tambah-tujuan bg-green-500 text-white rounded-md w-8 h-8 flex items-center justify-center font-bold text-lg hover:bg-green-600 transform hover:scale-110"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg></button>
                                        <button title="Hapus Tujuan" class="hapus-tujuan bg-red-500 text-white rounded-md w-8 h-8 flex items-center justify-center hover:bg-red-600 transform hover:scale-110"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                                    </div>
                                </div>
                            </td>`;
                        tr.innerHTML = rowHTML;
                        bodyTabel.appendChild(tr);
                    });
                });
            };

            // --- FUNGSI AKSI & MANIPULASI DATA ---
            const editPelajaran = (e) => {
                const input = e.target;
                const oldName = input.dataset.oldName;
                const newName = input.value.trim();
                let data = Database.getData();
                if (newName === oldName || !newName) { input.value = oldName; return; }
                if (data.pelajaran.includes(newName)) { showModal('Nama pelajaran sudah ada!', false); input.value = oldName; return; }
                const index = data.pelajaran.indexOf(oldName);
                if (index > -1) {
                    data.pelajaran[index] = newName;
                    data.kriteria[newName] = data.kriteria[oldName];
                    delete data.kriteria[oldName];
                    Database.simpanData(data);
                    input.dataset.oldName = newName;
                }
            };
            const hapusPelajaran = (namaPelajaran) => {
                showKonfirmasiModal(`Yakin ingin menghapus pelajaran "${namaPelajaran}"?`, () => {
                    let data = Database.getData();
                    data.pelajaran = data.pelajaran.filter(p => p !== namaPelajaran);
                    delete data.kriteria[namaPelajaran];
                    Database.simpanData(data);
                    renderDaftarPelajaran();
                    showModal(`Pelajaran "${namaPelajaran}" berhasil dihapus.`);
                });
            };
            const simpanDOMKeMemori = () => {
                const newRows = [];
                const trs = bodyTabel.getElementsByTagName('tr');
                let currentCapaianItem = null;
                for (const tr of trs) {
                    const capaianCell = tr.querySelector('td.capaian-cell');
                    if (capaianCell) {
                        currentCapaianItem = {
                            capaian: capaianCell.querySelector('textarea').value.trim(),
                            tujuanList: []
                        };
                        newRows.push(currentCapaianItem);
                    }
                    const textareas = tr.querySelectorAll('textarea');
                    const highlightInput = tr.querySelector('.highlight-input');
                    const highlightIndex = highlightInput ? parseInt(highlightInput.value, 10) || null : null;
                    const capaianOffset = capaianCell ? 1 : 0;
                    const tujuan = textareas[capaianOffset].value.trim();
                    const materi = textareas[capaianOffset + 1].value.trim();
                    const kriteria = [];
                    for (let i = capaianOffset + 2; i < textareas.length; i++) {
                        kriteria.push(textareas[i].value.trim());
                    }
                    if (currentCapaianItem) {
                        currentCapaianItem.tujuanList.push({ tujuan, materi, kriteria, highlightIndex });
                    }
                }
                return newRows;
            };
            const simpanPerubahan = () => {
                let data = Database.getData();
                const currentKelasKey = `kelas_${data.info.kelas}`;
                if (!data.kriteria[pelajaranAktif]) { data.kriteria[pelajaranAktif] = {}; }
                const headerInputs = headerKriteria.querySelectorAll('input');
                const newHeaders = Array.from(headerInputs).map(input => input.value.trim());
                const newRows = simpanDOMKeMemori();
                data.kriteria[pelajaranAktif][currentKelasKey] = { headers: newHeaders, rows: newRows };
                Database.simpanData(data);
                return data.info.kelas;
            };

            // --- EVENT LISTENERS ---
            kelasSelect.addEventListener('change', updateFase);
            formInfo.addEventListener('submit', (e) => {
                e.preventDefault();
                let data = Database.getData();
                data.info = {
                    namaSekolah: document.getElementById('namaSekolah').value, kelas: document.getElementById('kelas').value,
                    fase: document.getElementById('fase').value, tahunAjaran: document.getElementById('tahunAjaran').value,
                    phone: document.getElementById('phone').value, namaKepsek: document.getElementById('namaKepsek').value,
                    nipKepsek: document.getElementById('nipKepsek').value, namaGuru: document.getElementById('namaGuru').value,
                    nipGuru: document.getElementById('nipGuru').value,
                };
                Database.simpanData(data);
                showModal('Informasi umum berhasil disimpan!');
            });
            formPelajaran.addEventListener('submit', (e) => {
                e.preventDefault();
                const inputPelajaran = document.getElementById('namaPelajaran');
                const namaPelajaranBaru = inputPelajaran.value.trim();
                if (namaPelajaranBaru) {
                    let data = Database.getData();
                    if (data.pelajaran.includes(namaPelajaranBaru)) { showModal('Nama pelajaran sudah ada!', false); return; }
                    data.pelajaran.push(namaPelajaranBaru);
                    data.kriteria[namaPelajaranBaru] = {};
                    Database.simpanData(data);
                    renderDaftarPelajaran();
                    inputPelajaran.value = '';
                }
            });

            // Navigasi
            tombolKembali.addEventListener('click', () => tampilkanHalaman('halaman-awal'));
            tombolInfoUmum.addEventListener('click', () => tampilkanHalaman('halaman-awal'));
            tombolTutorial.addEventListener('click', () => tampilkanHalaman('halaman-tutorial'));

            tombolTambahCapaian.addEventListener('click', () => {
                const currentRows = simpanDOMKeMemori();
                currentRows.push(getDefaultCapaianItem());
                renderTabelKriteria({ headers: getDefaultKriteriaHeaders(), rows: currentRows });
            });
            bodyTabel.addEventListener('click', (e) => {
                const tambahBtn = e.target.closest('.tambah-tujuan');
                const hapusBtn = e.target.closest('.hapus-tujuan');
                if (tambahBtn) {
                    const tr = tambahBtn.closest('tr');
                    const capaianIndex = parseInt(tr.dataset.capaianIndex);
                    const currentRows = simpanDOMKeMemori();
                    currentRows[capaianIndex].tujuanList.push({ tujuan: '', materi: '', kriteria: Array(6).fill(''), highlightIndex: 3 });
                    renderTabelKriteria({ headers: getDefaultKriteriaHeaders(), rows: currentRows });
                }
                if (hapusBtn) {
                    const tr = hapusBtn.closest('tr');
                    const capaianIndex = parseInt(tr.dataset.capaianIndex);
                    const tujuanIndex = parseInt(tr.dataset.tujuanIndex);
                    const currentRows = simpanDOMKeMemori();
                    const capaianItem = currentRows[capaianIndex];
                    if (capaianItem.tujuanList.length > 1) {
                        capaianItem.tujuanList.splice(tujuanIndex, 1);
                    } else {
                        currentRows.splice(capaianIndex, 1);
                    }
                    renderTabelKriteria({ headers: getDefaultKriteriaHeaders(), rows: currentRows });
                }
            });
            bodyTabel.addEventListener('input', (e) => {
                if (e.target.classList.contains('highlight-input')) {
                    const input = e.target;
                    const tr = input.closest('tr');
                    const kriteriaCells = tr.querySelectorAll('.kriteria-cell');
                    kriteriaCells.forEach(cell => cell.classList.remove('bg-green-200'));
                    const highlightValue = parseInt(input.value, 10);
                    if (highlightValue >= 1 && highlightValue <= 6) {
                        kriteriaCells[highlightValue - 1].classList.add('bg-green-200');
                    }
                }
            });
            tombolSimpanTabel.addEventListener('click', () => {
                const kelasDisimpan = simpanPerubahan();
                showModal(`Data untuk pelajaran "${pelajaranAktif}" kelas ${kelasDisimpan} berhasil disimpan!`);
            });
            tombolBackup.addEventListener('click', () => { Database.backup(showModal); });
            fileRestoreInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                Database.restore(file, showModal);
                e.target.value = '';
            });
            tombolResetSemua.addEventListener('click', () => {
                showKonfirmasiModal('Anda yakin ingin mereset SEMUA data aplikasi? Tindakan ini tidak dapat dibatalkan.', () => {
                    Database.resetAllData(showModal);
                });
            });
            tombolResetHalaman.addEventListener('click', () => {
                const data = Database.getData();
                const kelas = data.info.kelas;
                showKonfirmasiModal(`Yakin ingin mereset data untuk pelajaran "${pelajaranAktif}" kelas ${kelas}? Data akan dikembalikan ke default (jika ada).`, () => {
                    Database.resetPelajaranData(pelajaranAktif, kelas);
                    showModal(`Data untuk pelajaran "${pelajaranAktif}" kelas ${kelas} telah direset.`);
                    bukaHalamanTabel(pelajaranAktif);
                });
            });
            tombolDownloadFormat.addEventListener('click', () => {
                const dataToExport = [];
                const currentRows = simpanDOMKeMemori();
                const headerInputs = headerKriteria.querySelectorAll('input');
                const kriteriaHeaders = Array.from(headerInputs).map(input => input.value.trim());
                const mainHeaders = ['Capaian Pembelajaran', 'Tujuan Pembelajaran', 'Materi', ...kriteriaHeaders];
                currentRows.forEach(capaianItem => {
                    capaianItem.tujuanList.forEach((tujuanItem, index) => {
                        let rowObject = {};
                        rowObject[mainHeaders[0]] = (index === 0) ? capaianItem.capaian : '';
                        rowObject[mainHeaders[1]] = tujuanItem.tujuan;
                        rowObject[mainHeaders[2]] = tujuanItem.materi;
                        kriteriaHeaders.forEach((header, i) => { rowObject[header] = tujuanItem.kriteria[i]; });
                        dataToExport.push(rowObject);
                    });
                });
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                worksheet['!cols'] = [{ wch: 40 }, { wch: 40 }, { wch: 30 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 20 }];
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Data Kriteria');
                XLSX.writeFile(workbook, `Format-${pelajaranAktif}-Kelas-${Database.getData().info.kelas}.xlsx`);
            });
            fileImporInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet);
                        const importedHeaders = Object.keys(json[0]);
                        const newKriteriaHeaders = importedHeaders.slice(3);
                        const newRows = [];
                        let currentCapaianItem = null;
                        json.forEach(row => {
                            if (row['Capaian Pembelajaran']) {
                                currentCapaianItem = { capaian: row['Capaian Pembelajaran'], tujuanList: [] };
                                newRows.push(currentCapaianItem);
                            }
                            if (currentCapaianItem) {
                                const kriteriaValues = newKriteriaHeaders.map(h => row[h] || '');
                                currentCapaianItem.tujuanList.push({
                                    tujuan: row['Tujuan Pembelajaran'] || '',
                                    materi: row['Materi'] || '',
                                    kriteria: kriteriaValues,
                                    highlightIndex: 3
                                });
                            }
                        });
                        renderTabelKriteria({ headers: newKriteriaHeaders, rows: newRows });
                        const kelasDisimpan = simpanPerubahan();
                        showModal(`Data berhasil diimpor dan disimpan untuk kelas ${kelasDisimpan}!`);
                    } catch (error) { showModal("Gagal memproses file Excel. Pastikan formatnya benar.", false); } 
                    finally { e.target.value = ''; }
                };
                reader.readAsArrayBuffer(file);
            });
            tombolDownloadPdf.addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape' });
                const data = Database.getData();
                const info = data.info;

                doc.setFontSize(14);
                doc.text(`Kriteria Ketercapaian Tujuan Pembelajaran`, doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
                doc.setFontSize(10);
                doc.text(`${info.namaSekolah}`, doc.internal.pageSize.getWidth() / 2, 22, { align: 'center' });
                
                let startY = 30;
                doc.text(`Mata Pelajaran: ${pelajaranAktif}`, 14, startY);
                doc.text(`Kelas: ${info.kelas} / Fase ${info.fase}`, doc.internal.pageSize.getWidth() / 2, startY);
                doc.text(`Tahun Ajaran: ${info.tahunAjaran}`, doc.internal.pageSize.getWidth() - 14, startY, { align: 'right' });

                const head = [];
                const body = [];
                
                const headerRow1 = [
                    { content: 'Capaian Pembelajaran', rowSpan: 2, styles: { valign: 'middle' } },
                    { content: 'Tujuan Pembelajaran', rowSpan: 2, styles: { valign: 'middle' } },
                    { content: 'Materi', rowSpan: 2, styles: { valign: 'middle' } },
                    { content: 'Kriteria Tujuan Pembelajaran', colSpan: 6, styles: { halign: 'center' } },
                ];
                const headerRow2 = [];
                const headerInputs = headerKriteria.querySelectorAll('input');
                headerInputs.forEach(input => headerRow2.push(input.value.trim()));
                head.push(headerRow1);
                head.push(headerRow2);

                const currentRows = simpanDOMKeMemori();
                currentRows.forEach(capaianItem => {
                    capaianItem.tujuanList.forEach((tujuanItem, tujuanIndex) => {
                        const row = [];
                        if (tujuanIndex === 0) { row.push({ content: capaianItem.capaian, rowSpan: capaianItem.tujuanList.length }); }
                        row.push(tujuanItem.tujuan);
                        row.push(tujuanItem.materi);
                        tujuanItem.kriteria.forEach((k, kIndex) => {
                            row.push({ content: k, styles: { fillColor: (tujuanItem.highlightIndex && (kIndex + 1) === tujuanItem.highlightIndex) ? '#c6f6d5' : null } });
                        });
                        body.push(row);
                    });
                });
                
                doc.autoTable({ head: head, body: body, startY: startY + 5, theme: 'grid' });

                let finalY = doc.lastAutoTable.finalY + 10;
                if (finalY > doc.internal.pageSize.getHeight() - 60) { doc.addPage(); finalY = 20; }

                const today = new Date();
                const formattedDate = today.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                
                doc.text(`Jakarta, ${formattedDate}`, doc.internal.pageSize.getWidth() - 14, finalY, { align: 'right' });
                finalY += 7;
                doc.text('Mengetahui,', 14, finalY);
                finalY += 5;
                doc.text('Kepala Sekolah', 14, finalY);
                doc.text('Guru Kelas', doc.internal.pageSize.getWidth() - 14, finalY, { align: 'right' });
                finalY += 20;
                doc.text(info.namaKepsek, 14, finalY);
                doc.text(info.namaGuru, doc.internal.pageSize.getWidth() - 14, finalY, { align: 'right' });
                finalY += 5;
                doc.text(`NIP. ${info.nipKepsek || '-'}`, 14, finalY);
                doc.text(`NIP. ${info.nipGuru || '-'}`, doc.internal.pageSize.getWidth() - 14, finalY, { align: 'right' });

                doc.save(`KKTP-${pelajaranAktif}-Kelas-${info.kelas}.pdf`);
            });

            // --- INISIALISASI ---
            populateKelasDropdown();
            renderInfoForm();
            renderDaftarPelajaran();
            tampilkanHalaman('halaman-tutorial');
        });
    </script>
</body>
</html>
