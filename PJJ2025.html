<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Pembelajaran</title>
    <style>
        /* General Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f9;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
        }
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.2s;
        }
        button:hover { opacity: 0.9; transform: translateY(-2px); }

        /* Page Content Styles */
        #pageContent.hidden { display: none; }
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #34495e; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        tr:hover { background-color: #e8f4fd; }
        td a { color: #3498db; text-decoration: none; }
        td a:hover { text-decoration: underline; }
        .actions { display: flex; gap: 10px; }

        /* Modal Base Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        .modal.visible { display: flex; }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 700px;
            border-radius: 8px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px; right: 20px;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover, .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Form Styles */
        form { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: 600; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; background-color: white; }
        button[type="submit"] { background-color: #2ecc71; color: white; grid-column: 1 / -1; }
        
        /* Specific Modals */
        #passwordModal .modal-content { max-width: 400px; }
        #passwordError { color: #e74c3c; margin-top: 10px; text-align: center; display: none; }
        
        #notificationModal .modal-content { max-width: 450px; text-align: center; }
        #notificationMessage { font-size: 1.1em; margin-bottom: 20px; }
        
        #confirmationModal .modal-content { max-width: 450px; text-align: center; }
        #confirmationMessage { font-size: 1.1em; margin-bottom: 20px; }
        .confirmation-buttons { display: flex; justify-content: center; gap: 15px; }
        .btn-confirm-yes { background-color: #e74c3c; color: white; }
        .btn-confirm-no { background-color: #bdc3c7; color: white; }

        /* Loader Styles */
        #loader-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        #loader-overlay.visible { display: flex; }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Buttons */
        .btn-primary { background-color: #3498db; color: white; }
        .btn-edit { background-color: #f1c40f; color: white; }
        .btn-delete { background-color: #e74c3c; color: white; }
    </style>
</head>
<body>
    <div id="loader-overlay">
        <div class="spinner"></div>
    </div>
    
    <div id="passwordModal" class="modal visible">
        <div class="modal-content">
            <h2>Masukkan Password</h2>
            <form id="passwordForm">
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn-primary" style="grid-column: 1 / -1;">Masuk</button>
            </form>
            <p id="passwordError">Password salah. Silakan coba lagi.</p>
        </div>
    </div>

    <div id="pageContent" class="container hidden">
        <div class="main-header">
            <h1>Database Pembelajaran</h1>
            <button id="showAddModalBtn" class="btn-primary">Tambah Data Baru</button>
        </div>
        <hr>
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Kelas</th><th>Pelajaran</th><th>Tujuan</th><th>Materi</th><th>RPP</th><th>Video</th><th>Media</th><th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <div id="addModal" class="modal">
        </div>

    <div id="editModal" class="modal">
        </div>

    <div id="notificationModal" class="modal">
        <div class="modal-content">
            <p id="notificationMessage"></p>
            <button id="notificationOkBtn" class="btn-primary">OK</button>
        </div>
    </div>

    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <p id="confirmationMessage"></p>
            <div class="confirmation-buttons">
                <button id="confirmYesBtn" class="btn-confirm-yes">Ya, Hapus</button>
                <button id="confirmNoBtn" class="btn-confirm-no">Batal</button>
            </div>
        </div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycby9pCKDsubgrETJU2mciuib2mP8m7cpUFI0Vy_ky1TdKkLopCQfOmTc6rx7MTEqkJo8/exec';
        
        // --- ELEMENT SELECTORS ---
        const pageContent = document.getElementById('pageContent');
        const loaderOverlay = document.getElementById('loader-overlay');
        const dataTableBody = document.querySelector("#dataTable tbody");
        
        // Modal Elements
        const passwordModal = document.getElementById('passwordModal');
        const addModal = document.getElementById('addModal');
        const editModal = document.getElementById('editModal');
        const notificationModal = document.getElementById('notificationModal');
        const confirmationModal = document.getElementById('confirmationModal');
        
        // Form & Button Elements
        const showAddModalBtn = document.getElementById('showAddModalBtn');
        const passwordForm = document.getElementById('passwordForm');

        // --- UTILITY FUNCTIONS ---
        const showLoader = (show) => loaderOverlay.classList.toggle('visible', show);
        const showModal = (modal, show) => modal.classList.toggle('visible', show);

        // Custom Alert/Notification
        function showNotification(message) {
            document.getElementById('notificationMessage').textContent = message;
            showModal(notificationModal, true);
            return new Promise(resolve => {
                document.getElementById('notificationOkBtn').onclick = () => {
                    showModal(notificationModal, false);
                    resolve();
                };
            });
        }
        
        // Custom Confirm
        function showConfirmation(message) {
            document.getElementById('confirmationMessage').textContent = message;
            showModal(confirmationModal, true);
            return new Promise(resolve => {
                document.getElementById('confirmYesBtn').onclick = () => {
                    showModal(confirmationModal, false);
                    resolve(true); // User clicked Yes
                };
                document.getElementById('confirmNoBtn').onclick = () => {
                    showModal(confirmationModal, false);
                    resolve(false); // User clicked No
                };
            });
        }
        
        // --- PASSWORD HANDLING ---
        passwordForm.addEventListener('submit', e => {
            e.preventDefault();
            const passwordInput = document.getElementById('password');
            const passwordError = document.getElementById('passwordError');
            if (passwordInput.value === 'PJJ2025') {
                showModal(passwordModal, false);
                pageContent.classList.remove('hidden');
                fetchData();
            } else {
                passwordError.style.display = 'block';
                passwordInput.value = '';
            }
        });

        // --- FETCH AND DISPLAY DATA ---
        function fetchData() {
            showLoader(true);
            dataTableBody.innerHTML = '';
            fetch(scriptURL)
                .then(response => response.json())
                .then(data => {
                    const tableData = data.slice(1);
                    tableData.forEach((rowData, index) => {
                        if (rowData.every(cell => cell === "")) return;
                        
                        const row = document.createElement('tr');
                        // Data columns (from index 1 to 7)
                        for(let i = 1; i < rowData.length; i++) {
                            const cell = document.createElement('td');
                            if (String(rowData[i]).startsWith('http')) {
                                cell.innerHTML = `<a href="${rowData[i]}" target="_blank">Link</a>`;
                            } else {
                                cell.textContent = rowData[i];
                            }
                            row.appendChild(cell);
                        }

                        // Actions column
                        const actionCell = document.createElement('td');
                        actionCell.classList.add('actions');
                        const editButton = document.createElement('button');
                        editButton.textContent = 'Edit';
                        editButton.classList.add('btn-edit');
                        editButton.onclick = () => openEditModal(index + 2, rowData);

                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Hapus';
                        deleteButton.classList.add('btn-delete');
                        deleteButton.onclick = () => deleteData(index + 2);

                        actionCell.appendChild(editButton);
                        actionCell.appendChild(deleteButton);
                        row.appendChild(actionCell);
                        
                        dataTableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    showNotification('Gagal memuat data. Periksa koneksi internet Anda.');
                })
                .finally(() => showLoader(false));
        }

        // --- FORM TEMPLATE (to reuse for Add and Edit) ---
        function getFormHtml(idPrefix = '', data = {}) {
            return `
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <h2>${idPrefix ? 'Edit' : 'Input'} Data Pembelajaran</h2>
                    <form id="${idPrefix}dataForm">
                        ${idPrefix ? `<input type="hidden" id="${idPrefix}RowId" name="rowId" value="${data.rowId || ''}">` : ''}
                        <div class="form-group">
                            <label for="${idPrefix}kelas">Kelas</label>
                            <select id="${idPrefix}kelas" name="Kelas" required>
                                <option value="">Pilih Kelas</option>
                                ${['1', '2', '3', '4', '5', '6'].map(n => `<option value="Kelas ${n}" ${data.Kelas === `Kelas ${n}` ? 'selected' : ''}>Kelas ${n}</option>`).join('')}
                                <option value="Lainnya" ${data.Kelas === 'Lainnya' ? 'selected' : ''}>Lainnya</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="${idPrefix}pelajaran">Pelajaran</label>
                            <select id="${idPrefix}pelajaran" name="Pelajaran" required>
                                <option value="">Pilih Pelajaran</option>
                                ${['Pendidikan Agama Islam','Pendidikan Agama Kristen','Pendidikan Agama Katholik','Pendidikan Agama Hindu','Pendidikan Agama Budha','Pendidikan Agama Konghucu','Pendidikan Pancasila','Bahasa Indonesia','Matematika','Ilmu Pengetahuan Alam dan Sosial','Seni dan Budaya','Pendidikan Jasmani Olahraga dan Kesehatan','Pendidikan Lingkungan dan Budaya Jakarta','Bahasa Inggris','Koding dan Kecerdasan Buatan','Mulok'].map(p => `<option value="${p}" ${data.Pelajaran === p ? 'selected' : ''}>${p}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group"><label for="${idPrefix}tujuan">Tujuan</label><input type="text" id="${idPrefix}tujuan" name="Tujuan" value="${data.Tujuan || ''}" required></div>
                        <div class="form-group"><label for="${idPrefix}materi">Materi</label><input type="text" id="${idPrefix}materi" name="Materi" value="${data.Materi || ''}" required></div>
                        <div class="form-group"><label for="${idPrefix}rpp">Link RPP</label><input type="text" id="${idPrefix}rpp" name="RPP" value="${data.RPP || ''}" required></div>
                        <div class="form-group"><label for="${idPrefix}video">Link Video</label><input type="text" id="${idPrefix}video" name="Video" value="${data.Video || ''}" required></div>
                        <div class="form-group"><label for="${idPrefix}media">Link Media</label><input type="text" id="${idPrefix}media" name="Media" value="${data.Media || ''}" required></div>
                        <button type="submit">${idPrefix ? 'Simpan Perubahan' : 'Simpan Data'}</button>
                    </form>
                </div>
            `;
        }
        
        // --- EVENT LISTENERS FOR MODALS ---
        function setupModalEvents(modal, formId, submitHandler) {
            const form = modal.querySelector(`#${formId}`);
            const closeBtn = modal.querySelector('.close-button');

            form.addEventListener('submit', submitHandler);
            closeBtn.onclick = () => showModal(modal, false);
        }

        // Open Add Modal
        showAddModalBtn.onclick = function() {
            addModal.innerHTML = getFormHtml();
            showModal(addModal, true);
            setupModalEvents(addModal, 'dataForm', handleAddSubmit);
        }

        // Open Edit Modal
        function openEditModal(rowId, rowData) {
            const data = {
                rowId,
                Kelas: rowData[1],
                Pelajaran: rowData[2],
                Tujuan: rowData[3],
                Materi: rowData[4],
                RPP: rowData[5],
                Video: rowData[6],
                Media: rowData[7]
            };
            editModal.innerHTML = getFormHtml('edit', data);
            showModal(editModal, true);
            setupModalEvents(editModal, 'editdataForm', handleEditSubmit);
        }

        // --- SUBMIT HANDLERS ---
        async function handleAddSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Menyimpan...';

            const formData = new FormData(form);
            formData.append('action', 'insert');

            try {
                const response = await fetch(scriptURL, { method: 'POST', body: formData });
                const data = await response.json();
                if (data.result !== 'success') throw new Error(data.message || 'Unknown error');
                
                showModal(addModal, false);
                await showNotification('Data berhasil disimpan!');
                fetchData();
            } catch (error) {
                console.error('Error!', error.message);
                await showNotification('Gagal menyimpan data: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Simpan Data';
            }
        }

        async function handleEditSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Menyimpan...';
            
            const formData = new FormData(form);
            formData.append('action', 'update');
            
            try {
                const response = await fetch(scriptURL, { method: 'POST', body: formData });
                const data = await response.json();
                if (data.result !== 'success') throw new Error(data.message || 'Unknown error');

                showModal(editModal, false);
                await showNotification('Data berhasil diperbarui!');
                fetchData();
            } catch(error) {
                console.error('Error!', error.message);
                await showNotification('Gagal memperbarui data: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Simpan Perubahan';
            }
        }

        // --- DELETE DATA ---
        async function deleteData(rowId) {
            const confirmed = await showConfirmation('Apakah Anda yakin ingin menghapus data ini? Aksi ini tidak dapat dibatalkan.');
            
            if (confirmed) {
                showLoader(true);
                const formData = new FormData();
                formData.append('action', 'delete');
                formData.append('rowId', rowId);

                try {
                    const response = await fetch(scriptURL, { method: 'POST', body: formData });
                    const data = await response.json();
                    if (data.result !== 'success') throw new Error(data.message || 'Unknown error');
                    
                    await showNotification('Data berhasil dihapus!');
                    fetchData(); // Refreshes data, which also removes loader
                } catch(error) {
                    console.error('Error!', error.message);
                    await showNotification('Gagal menghapus data: ' + error.message);
                    showLoader(false);
                }
            }
        }

        // Close modal if clicked outside content
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('visible');
            }
        }
    </script>
</body>
</html>
